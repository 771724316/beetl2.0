<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
<meta name="generator" content="AsciiDoc 8.6.9" />
<title>Beetl2.5使用说明书20160911</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Beetl2.5使用说明书20160911</h1>
<span id="author">李家智</span><br />
<span id="email"><code>&lt;<a href="mailto:xiandafu@126.com">xiandafu@126.com</a>&gt;</code></span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_什么是beetl">1. 什么是Beetl</h2>
<div class="sectionbody">
<div class="paragraph"><p>Beetl目前版本是2.5.2,相对于其他java模板引擎，具有功能齐全，语法直观,性能超高，以及编写的模板容易维护等特点。使得开发和维护模板有很好的体验。是新一代的模板引擎。总得来说，它的特性如下：</p></div>
<div class="ulist"><ul>
<li>
<p>
功能完备：作为主流模板引擎，Beetl具有相当多的功能和其他模板引擎不具备的功能。适用于*各种应用场景*，从对响应速度有很高要求的大网站到功能繁多的CMS管理系统都适合。Beetl本身还具有很多独特功能来完成模板编写和维护，这是其他模板引擎所不具有的。
</p>
</li>
<li>
<p>
非常简单：类似Javascript语法和习俗，只要半小时就能通过半学半猜完全掌握用法。拒绝其他模板引擎那种非人性化的语法和习俗。同时也能支持html 标签，使得开发CMS系统比较容易
</p>
</li>
<li>
<p>
超高的性能：Beetl 远超过主流java模板引擎性能(引擎性能5-6倍与freemaker，2倍于JSP。参考附录），而且消耗较低的CPU
</p>
</li>
<li>
<p>
易于整合：Beetl能很容易的与各种web框架整合，如Spring MVC，JFinal,Struts,Nutz，Jodd，Servlet等。
</p>
</li>
<li>
<p>
支持模板单独开发和测试，即在MVC架构中，即使没有M和C部分，也能开发和测试模板。
</p>
</li>
<li>
<p>
扩展和个性化：Beetl支持自定义方法，格式化函数，虚拟属性，标签，和HTML标签. 同时Beetl也支持自定义占位符和控制语句起始符号也支持使用者完全可以打造适合自己的工具包.
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="title">关于性能</div>
<div class="paragraph"><p>通过与主流模板引擎Freemarker，Vecloity以及JSP对比，Beetl6倍于Freemarker，2倍于JSP。这是因为宏观上，通过了优化的渲染引擎，IO的二进制输出，字节码属性访问增强，微观上，通过一维数组保存上下文Context,静态文本合并处理，通过重复使用字节数组来防止java频繁的创建和销毁数组，还使用模板缓存，运行时优化等方法。详情参考附录</p></div>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">独特功能</div>
<div class="paragraph"><p>Beetl有些功能是发展了10多年的模板引擎所不具备的，这些功能非常利于模板的开发和维护，如下</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
自定义占位符和控制语句起始符号，这有利于减小模板语法对模板的倾入性，比如在html模板中，如果定义控制语句符号是<code>&lt;!--:和 --&gt;</code>,那么，大部分模板文件都能通过浏览器打开。有的使用者仅仅采用了单个符号@ （或者单个符号“～”）以及回车换号作为控制语句起始符号，这又能提高开发效率
</p>
</li>
<li>
<p>
可单独测试的模板。无需真正的控制层和模型层，Beetl的模板就可以单独开发和<strong>测试</strong>
</p>
</li>
<li>
<p>
同时支持较为松散的MVC和严格的MVC，如果在模板语言里嵌入计算表达式，复杂条件表达式，以及函数调用有干涉业务逻辑嫌疑，你可以禁止使用这些语法。
</p>
</li>
<li>
<p>
强大的安全输出，通过安全输出符号！，能在模板变量，变量属性引用，for循环，占位符输出，try-catch中等各个地方提供安全输出，保证渲染正常
</p>
</li>
<li>
<p>
模板变量：运行将模板的某一部分输出像js那样赋值给一个变量，稍后再处理。利用模板变量能完成非常复杂的页面布局（简单的布局可使用include,layout标签函数)
</p>
</li>
<li>
<p>
类型推测，能在运行的时候推测模板变量类型，从而优化性能，也可以通过注解的方法显示的说明模板变量属性（这是非必须的，但有助于IDE自动提示功能）
</p>
</li>
<li>
<p>
可插拔的设计，错误信息提示，模板引擎缓存机制，模板资源管理，本地调用的安全管理器,严格MVC限制，模板引擎本身都有默认的实现，但又完全可以自定义以适合特定需求
</p>
</li>
<li>
<p>
增强的语法，如for-elsefor, select-case，安全输出符号!,省略的三元表达式 等，这些语法特别适合模板开发
</p>
</li>
<li>
<p>
局部渲染技术，结合现在js的ajax技术。
</p>
</li>
<li>
<p>
性能超高,具有最快的模板解释引擎，同时，又有较低的CPU消耗。5-6倍于国内使用的Freemaker。适合各类模板应用，如代码生成工具，CMS系统，普通网站，超高访问量的门户系统，和富客户端JS框架整合的后台管理应用
</p>
</li>
</ol></div>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">小白如何开始</div>
<div class="ulist"><ul>
<li>
<p>
需要通读基本用法，大部分都是讲解语法，而语法跟js很接近，所以可以快速预览，但Beetl是针对模板设计，
所以像安全输出，标签和html标签，全局变量，临时变量和共享变量，布局技术，以及直接调用java代码等还需要认真读一遍。
</p>
</li>
<li>
<p>
如果从事web开发，还需要阅读web集成里的第一节“web提供的全局变量”，如果web里还使用ajax技术，可以阅读“整合ajax的局部渲染技术”。
</p>
</li>
<li>
<p>
包含有spring,jfinal,jodd,struts 等demo可以作为参考学习用 <a href="http://ibeetl.com/community/?/article/4">http://ibeetl.com/community/?/article/4</a>
</p>
</li>
<li>
<p>
任何问题，都可以在ibeetl.com 社区上提问。目前答复率是100%，提问需要详细说明自己的期望，出错信息，附上代码或者图片
</p>
</li>
</ul></div>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">联系作者</div>
<div class="paragraph"><p>作者：闲.大赋 （李家智）等（参考附录查看代码贡献者)</p></div>
<div class="paragraph"><p>QQ技术交流群：219324263</p></div>
<div class="paragraph"><p>邮件：<a href="mailto:xiandafu@126.com">xiandafu@126.com</a></p></div>
<div class="paragraph"><p>Beetl社区：ibeetl.com</p></div>
<div class="paragraph"><p>源码主页：https://github.com/javamonkey/beetl2.0</p></div>
<div class="paragraph"><p>在线体验和代码分享  <a href="http://ibeetl.com:8080/beetlonline/">http://ibeetl.com:8080/beetlonline/</a></p></div>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_基本用法">2. 基本用法</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_从grouptemplate开始">2.1. 从GroupTemplate开始</h3>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">StringTemplateResourceLoader</span> <span class="n">resourceLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTemplateResourceLoader</span><span class="o">();</span>
<span class="n">Configuration</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="na">defaultConfiguration</span><span class="o">();</span>
<span class="n">GroupTemplate</span> <span class="n">gt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroupTemplate</span><span class="o">(</span><span class="n">resourceLoader</span><span class="o">,</span> <span class="n">cfg</span><span class="o">);</span>
<span class="n">Template</span> <span class="n">t</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="s">&quot;hello,${name}&quot;</span><span class="o">);</span>
<span class="n">t</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;beetl&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">render</span><span class="o">();</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>Beetl的核心是GroupTemplate，创建GroupTemplate需要俩个参数，一个是模板资源加载器，一个是配置类，模板资源加载器Beetl内置了4种，分别是</p></div>
<div class="ulist"><ul>
<li>
<p>
StringTemplateResourceLoader：字符串模板加载器，用于加载字符串模板，如本例所示
</p>
</li>
<li>
<p>
FileResourceLoader：文件模板加载器，需要一个根目录作为参数构造，，传入getTemplate方法的String是模板文件相对于Root目录的相对路径
</p>
</li>
<li>
<p>
ClasspathResourceLoader：文件模板加载器，模板文件位于Classpath里
</p>
</li>
<li>
<p>
WebAppResourceLoader：用于webapp集成，假定模板根目录就是WebRoot目录，参考web集成章
</p>
</li>
<li>
<p>
MapResourceLoader : 可以动态存入模板
</p>
</li>
</ul></div>
<div class="paragraph"><p>代码第5行将变量name传入模板里，其值是“Beetl”。
代码第6行是渲染模板，得到输出，template提供了多种获得渲染输出的方法，如下</p></div>
<div class="ulist"><ul>
<li>
<p>
tempalte.render() 返回渲染结果，如本例所示
</p>
</li>
<li>
<p>
template.renderTo(Writer) 渲染结果输出到Writer里
</p>
</li>
<li>
<p>
template.renderTo(OutputStream ) 渲染结果输出到OutputStream里
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="olist arabic"><ol class="arabic">
<li>
<p>
关于如何使用模板资源加载器，请参考下一节
</p>
</li>
<li>
<p>
如何对模板进行配置，请参考下一节
</p>
</li>
</ol></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_模板基础配置">2.2. 模板基础配置</h3>
<div class="paragraph"><p>Beetl提供不但功能齐全，而且还有很多独特功能，通过简单的配置文件，就可以定义众多的功能，默认情况下，Configuration类总是会先加载默认的配置文件（位于/org/beetl/core/beetl-default.properties，作为新手，<strong>通常只需要关注3,4,5,6行定界符的配置，以及12行模板字符集的配置就可以了</strong>，其他配置会在后面章节陆续提到）下，其内容片断如下：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre>#默认配置
ENGINE=org.beetl.core.engine.FastRuntimeEngine
DELIMITER_PLACEHOLDER_START=${
DELIMITER_PLACEHOLDER_END=}
DELIMITER_STATEMENT_START=&lt;%
DELIMITER_STATEMENT_END=%&gt;
DIRECT_BYTE_OUTPUT = FALSE
HTML_TAG_SUPPORT = true
HTML_TAG_FLAG = #
HTML_TAG_BINDING_ATTRIBUTE = var
NATIVE_CALL = TRUE
TEMPLATE_CHARSET = UTF-8
ERROR_HANDLER = org.beetl.core.ConsoleErrorHandler
NATIVE_SECUARTY_MANAGER= org.beetl.core.DefaultNativeSecurityManager
MVC_STRICT = FALSE

\#资源配置，resource后的属性只限于特定ResourceLoader
RESOURCE_LOADER=org.beetl.core.resource.ClasspathResourceLoader
#classpath 根路径
RESOURCE.root= /
#是否检测文件变化
RESOURCE.autoCheck= true
#自定义脚本方法文件的Root目录和后缀
RESOURCE.functionRoot = functions
RESOURCE.functionSuffix = html
#自定义标签文件Root目录和后缀
RESOURCE.tagRoot = htmltag
RESOURCE.tagSuffix = tag
#####  扩展 ##############
## 内置的方法
FN.date = org.beetl.ext.fn.DateFunction
......
##内置的功能包
FNP.strutil = org.beetl.ext.fn.StringUtil
......
##内置的默认格式化函数
FTC.java.util.Date = org.beetl.ext.format.DateFormat
.....
## 标签类
TAG.include= org.beetl.ext.tag.IncludeTag
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>第2行配置引擎实现类，默认即可.</p></div>
<div class="paragraph"><p>第3,4行指定了占位符号，默认是${ }.也可以指定为其他占位符。</p></div>
<div class="paragraph"><p>第5,6行指定了语句的定界符号，默认是&lt;% %&gt;,也可以指定为其他定界符号</p></div>
<div class="paragraph"><p>第7行指定IO输出模式，默认是FALSE,即通常的字符输出，在考虑高性能情况下，可以设置成true。详细请参考高级用法</p></div>
<div class="paragraph"><p>第8,9行指定了支持HTML标签，且符号为#,默认配置下，模板引擎识别&lt;#tag &gt;&lt;/#tag&gt;这样的类似html标签，并能调用相应的标签函数或者模板文件。你也可以指定别的符号，如bg: 则识别&lt;bg:</p></div>
<div class="paragraph"><p>第10行 指定如果标签属性有var，则认为是需要绑定变量给模板的标签函数</p></div>
<div class="paragraph"><p>第11行指定允许本地Class直接调用</p></div>
<div class="paragraph"><p>第12行指定模板字符集是UTF-8</p></div>
<div class="paragraph"><p>第13行指定异常的解析类，默认是ConsoleErrorHandler，他将在render发生异常的时候在后台打印出错误信息（System.out)。</p></div>
<div class="paragraph"><p>第14行指定了本地Class调用的安全策略</p></div>
<div class="paragraph"><p>第15行配置了是否进行严格MVC，通常情况下，此处设置为false.</p></div>
<div class="paragraph"><p>第18行指定了默认使用的模板资源加载器</p></div>
<div class="paragraph"><p>第20到22行配置了模板资源加载器的一些属性，如设置根路径为/,即Classpath的顶级路径，并且总是检测模板是否更改</p></div>
<div class="paragraph"><p>第23行配置了自定义的方法所在的目录以及文件名后缀。beetl既支持通过java类定义方法，也支持通过模板文件来定义方法</p></div>
<div class="paragraph"><p>第26行配置了自定义的html标签所在的目录以及文件名后缀。beetl既支持通过java类定义标签，也支持通过模板文件来定义标签</p></div>
<div class="paragraph"><p>第31行注册了一个date方法，其实现类是org.beetl.ext.fn.DateFunction</p></div>
<div class="paragraph"><p>第34行注册了一个方法包strutil，其实现类org.beetl.ext.fn.StringUtil，此类的每个public方法都将注册为beetl的方法</p></div>
<div class="paragraph"><p>第37行注册了一个日期格式化函数</p></div>
<div class="paragraph"><p>第40行注册了一个include标签函数</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>模板开发者可以创建一个beetl.properties的配置文件，此时，该配置文件将覆盖默认的配置文件属性，比如，你的定界符考虑是&lt;!--: 和 -&#8594; ,则在beetl.properties加入一行即可,并将此配置文件放入Classpath根目录下即可。 Configuration.defaultConfiguration()总是先加载系统默认的，然后再加载Beetl.properties的配置属性，如果有重复，用后者代替前者的配置</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre>#自定义配置
DELIMITER_STATEMENT_START=&lt;!--:
DELIMITER_STATEMENT_END=--&gt;
</pre></div>
</td></tr></table></div></div>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>2.4.0 新功能:beetl 支持通过模板本生来完成函数，即模板函数，或者通过模板来实现HTML标签（而不用写java代码），可以beetl.properties为这种应用设置的不同的语句定界符来跟常规模板做区分，如下</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>FUNCTION_TAG_LIMITER=&lt;%;%&gt;
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>分号分割开，如果配置文件没有FUNCTION_TAG_LIMITER=，则模板函数，html标签使用同DELIMITER_STATEMENT_START，DELIMITER_STATEMENT_END</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_模板资源加载器">2.3. 模板资源加载器</h3>
<div class="paragraph"><p>资源加载器是根据String值获取Resource实例的工场类，同时资源加载器还要负责响应模板引擎询问模板是否变化的调用。对于新手来说，无需考虑模板资源加载器如何实现，只需要根据自己场景选择系统提供的三类模板资源加载器即可</p></div>
<div class="sect3">
<h4 id="_字符串模板加载器">2.3.1. 字符串模板加载器</h4>
<div class="paragraph"><p>在创建GroupTemplate过程中，如果传入的是StringTemplateResourceLoader，则允许通过调用gt.getTemplate(String template)来获取模板实例对象，如2.1所示</p></div>
</div>
<div class="sect3">
<h4 id="_文件资源模板加载器">2.3.2. 文件资源模板加载器</h4>
<div class="paragraph"><p>更通常情况下，模板资源是以文件形式管理的，集中放在某一个文件目录下（如webapp的模板根目录就可能是WEB-INF/template里），因此，可以使用FileResourceLoader来加载模板实例，如下代码：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">String</span> <span class="n">root</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;user.dir&quot;</span><span class="o">)+</span><span class="n">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">&quot;template&quot;</span><span class="o">;</span>
<span class="n">FileResourceLoader</span> <span class="n">resourceLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileResourceLoader</span><span class="o">(</span><span class="n">root</span><span class="o">,</span><span class="s">&quot;utf-8&quot;</span><span class="o">);</span>
<span class="n">Configuration</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="na">defaultConfiguration</span><span class="o">();</span>
<span class="n">GroupTemplate</span> <span class="n">gt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroupTemplate</span><span class="o">(</span><span class="n">resourceLoader</span><span class="o">,</span> <span class="n">cfg</span><span class="o">);</span>
<span class="n">Template</span> <span class="n">t</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="s">&quot;/s01/hello.txt&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">render</span><span class="o">();</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>第1行代码指定了模板根目录，即位于项目工程下的template目录
第2行构造了一个资源加载器，并指定字符集为UTF-8 (也可不指定，因为配置文件默认就是UTF-8);
第5行通过模板的相对路径/s01/hello.txt来加载模板</p></div>
</div>
<div class="sect3">
<h4 id="_classpath资源模板加载器">2.3.3. Classpath资源模板加载器</h4>
<div class="paragraph"><p>还有种常情况下，模板资源是打包到jar文件或者同Class放在一起，因此，可以使用ClasspathResourceLoader来加载模板实例，如下代码：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">ClasspathResourceLoader</span> <span class="n">resourceLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClasspathResourceLoader</span><span class="o">(</span><span class="s">&quot;org/beetl/sample/s01/”);</span>
<span class="s">Configuration cfg = Configuration.defaultConfiguration(“);</span>
<span class="s">GroupTemplate gt = new GroupTemplate(resourceLoader, cfg);</span>
<span class="s">Template t = gt.getTemplate(&quot;</span><span class="o">/</span><span class="n">hello</span><span class="o">.</span><span class="na">txt</span><span class="err">&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">render</span><span class="o">();</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>第1行代码指定了模板根目录，即搜索模板的时候从根目录开始，如果new ClasspathResourceLoader("template/"),则表示搜索template下的模板。此处用空构造函数，表示搜索路径是根路径，且字符集默认字符集UTF-8.</p></div>
<div class="paragraph"><p>第4行通过模板的相对路径org/beetl/sample/s01/hello.txt来加载模板</p></div>
</div>
<div class="sect3">
<h4 id="_webapp资源模板加载器">2.3.4. WebApp资源模板加载器</h4>
<div class="paragraph"><p>WebAppResourceLoader 是用于web应用的资源模板加载器，默认根路径是WebRoot目录。也可以通过制定root属性来设置相对于WebRoot的的模板根路径，从安全角考虑，建议放到WEB-INF目录下</p></div>
<div class="paragraph"><p>如下是Jfinal集成 里初始化GroupTemplate的方法</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">Configuration</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="na">defaultConfiguration</span><span class="o">();</span>
<span class="n">WebAppResourceLoader</span> <span class="n">resourceLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebAppResourceLoader</span><span class="o">();</span>
<span class="n">groupTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroupTemplate</span><span class="o">(</span><span class="n">resourceLoader</span><span class="o">,</span> <span class="n">cfg</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>WebAppResourceLoader 假定 beetl.jar 是位于 WEB-INF/lib 目录下，因此，可以通过WebAppResourceLoader类的路径来推断出WebRoot路径从而指定模板根路径。所有线上环境一般都是如此，如果是开发环境或者其他环境不符合此假设，你需要调用resourceLoader.setRoot() 来指定模板更路径</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_自定义资源模板加载器">2.3.5. 自定义资源模板加载器</h4>
<div class="paragraph"><p>有时候模板可能来自文件系统不同目录，或者模板一部分来自某个文件系统，另外一部分来自数据库，还有的情况模板可能是加密混淆的模板，此时需要自定义资源加载，继承ResouceLoader才能实现模板功能，这部分请参考高级部分</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_定界符与占位符号">2.4. 定界符与占位符号</h3>
<div class="paragraph"><p>Beetl模板语言类似JS语言和习俗，只需要将Beetl语言放入定界符号里即可，如默认的是&lt;% %&gt; ,占位符用于静态文本里嵌入占位符用于输出，如下是正确例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">a</span><span class="o">+</span><span class="nx">b</span><span class="p">;</span>
<span class="o">%&gt;</span>
<span class="nx">hello</span> <span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">=</span><span class="nx">$</span><span class="p">{</span><span class="nx">result</span><span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>千万不要在定界符里使用占位符号，因为占位符仅仅嵌在静态文本里，如下例子是<strong>错误</strong>例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="s2">&quot;hi&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">$</span><span class="p">{</span><span class="nx">a</span><span class="p">}</span><span class="o">+</span><span class="s2">&quot;beetl&quot;</span><span class="p">;</span> <span class="c1">//应该是var c = a+&quot;beetl&quot;</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>每次有人问我如上例子为啥不能运行的时候，我总是有点憎恶velocity 带来的这种非人性语法</p></div>
<div class="paragraph"><p>定界符和占位符 通常还有别的选择，如下定界符</p></div>
<div class="ulist"><ul>
<li>
<p>
@ 和回车换行 (此时,模板配置DELIMITER_STATEMENT_END= 或者 DELIMITER_STATEMENT_END=null 都可以)
</p>
</li>
<li>
<p>
#: 和回车换行
</p>
</li>
<li>
<p>
&lt;!--： 和 -&#8594;
</p>
</li>
<li>
<p>
&lt;!--# 和 -&#8594;
</p>
</li>
<li>
<p>
&lt;?  和  ?&gt;
</p>
</li>
</ul></div>
<div class="paragraph"><p>占位符:
- <sub> </sub>
- #{ }
- # #</p></div>
<div class="paragraph"><p>你也可以与团队达成一致意见来选择团队喜爱择定界符号和占位符号。</p></div>
<div class="paragraph"><p>定界符号里是表达式，如果表达式跟定界符或者占位符有冲突，可以在用 “\” 符号，如</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="err">@</span><span class="k">for</span><span class="p">(</span><span class="nx">user</span> <span class="k">in</span> <span class="nx">users</span><span class="p">){</span>
<span class="nx">email</span> <span class="nx">is</span> <span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="err">\@</span><span class="mi">163</span><span class="p">.</span><span class="nx">com</span>
<span class="err">@</span><span class="p">}</span>

<span class="nx">$</span><span class="p">{[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]}</span> <span class="c1">//输出一个json列表</span>
<span class="nx">$</span><span class="p">{</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">value</span><span class="o">:</span><span class="mi">2</span> <span class="err">\</span><span class="p">}</span>  <span class="p">}</span> <span class="c1">//输出一个json map，} 需要加上\</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_注释">2.5. 注释</h3>
<div class="paragraph"><p>Beetl语法类似js语法，所以注释上也同js一样：
单行注释采用//</p></div>
<div class="paragraph"><p>多行注视采用/**/</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="cm">/*此处是一个定义变量*/</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">//定义一个变量.</span>

<span class="cm">/* 以下内容都将被注释</span>
<span class="cm">%&gt;</span>

<span class="cm">&lt;% */</span> <span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>第2行是一个多行注释</p></div>
<div class="paragraph"><p>第3行是一个单行注释</p></div>
<div class="paragraph"><p>第5行到第8行采用的是多行注释，因此里面有内容也是注释，模板将不予处理</p></div>
</div>
<div class="sect2">
<h3 id="_临时变量定义">2.6. 临时变量定义</h3>
<div class="paragraph"><p>在模板中定义的变量成为临时变量，这类似js中采用var 定义的变量，如下例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="nx">c</span> <span class="o">=</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span><span class="nx">d</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="nx">e</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="p">{</span><span class="nx">key1</span><span class="o">:</span><span class="nx">a</span><span class="p">,</span><span class="nx">key2</span><span class="o">:</span><span class="nx">c</span><span class="p">};</span>
<span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">a</span><span class="o">+</span><span class="nx">b</span><span class="p">;</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_全局变量定义">2.7. 全局变量定义</h3>
<div class="paragraph"><p>全局变量是通过template.binding传入的变量,这些变量能在模板的任何一个地方，包括子模板都能访问到。如java代码里</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">template</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="s">&quot;list&quot;</span><span class="o">,</span><span class="n">service</span><span class="o">.</span><span class="na">getUserList</span><span class="o">());</span>

<span class="c1">//在模板里</span>
<span class="o">&lt;%</span>
<span class="k">for</span><span class="o">(</span><span class="n">user</span> <span class="n">in</span> <span class="n">list</span><span class="o">){</span>
<span class="o">%&gt;</span>
<span class="n">hello</span><span class="o">,</span><span class="n">$</span><span class="o">{</span><span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">};</span>
<span class="o">&lt;%}%&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_共享变量">2.8. 共享变量</h3>
<div class="paragraph"><p>共享变量指在所有模板中都可以引用的变量，可过groupTemplate.setSharedVars(Map&lt;String, Object&gt; sharedVars)传入的变量,这些变量能在 <strong>所有模板</strong> 的任何一个地方</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">.....</span>
<span class="n">GroupTemplate</span> <span class="n">gt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroupTemplate</span><span class="o">(</span><span class="n">resourceLoader</span><span class="o">,</span> <span class="n">cfg</span><span class="o">);</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">shared</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
<span class="n">shared</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;beetl&quot;</span><span class="o">);</span>
<span class="n">gt</span><span class="o">.</span><span class="na">setSharedVars</span><span class="o">(</span><span class="n">shared</span><span class="o">);</span>
<span class="n">Template</span> <span class="n">t</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="s">&quot;/org/beetl/sample/s0208/t1.txt&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">render</span><span class="o">();</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="s">&quot;/org/beetl/sample/s0208/t2.txt&quot;</span><span class="o">);</span>
<span class="n">str</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">render</span><span class="o">();</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">//t1.txt</span>
<span class="nx">hi</span><span class="p">,</span><span class="nx">$</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span>
<span class="c1">//t2.txt</span>
<span class="nx">hello</span><span class="p">,</span><span class="nx">$</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_模板变量">2.9. 模板变量</h3>
<div class="paragraph"><p>模板变量是一种特殊的变量，即可以将模板中任何一段的输出赋值到该变量，并允许稍后在其他地方使用，如下代码</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="s2">&quot;1234&quot;</span><span class="p">;</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
<span class="o">%&gt;</span>
<span class="nx">模板其他内容</span><span class="err">：</span>

<span class="o">&lt;%</span><span class="p">};</span> <span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>第2行定义了一个模板变量content = { &#8230;} ; 此变量跟临时变量一样，可以在其他地方使用，最常见的用户是用于复杂的布局。请参考高级用法布局</p></div>
</div>
<div class="sect2">
<h3 id="_引用属性">2.10. 引用属性</h3>
<div class="paragraph"><p>属性引用是模板中的重要一部分，beetl支持属性同javascript的支持方式一样，如下</p></div>
<div class="paragraph"><p>1        Beetl支持通过”.”号来访问对象的的属性，如果javascript一样。如果User对象有个getName()方法，那么在模板中，可以通过${xxx.name}来访问</p></div>
<div class="paragraph"><p>2   如果模板变量是数组或者List类，这可以通过[] 来访问，如${userList[0]}</p></div>
<div class="paragraph"><p>3   如果模板变量是Map类，这可以通过[]来访问，如${map[“name”]},如果key值是字符串类型，也可以使用${map.name}.但不建议这么使用，因为会让模板阅读者误以为是一个Pojo对象</p></div>
<div class="paragraph"><p>4   Beetl也支持Generic Get方式，即如果对象有一个public Object get(String key)方法，可以通过”.”号或者[]来访问，譬如
${activityRecord.name}或者${activityRecord[“name”] }都将调用activityRecord的 get(String key)方法。如果对象既有具体属性，又有Generic get（这种模型设计方式是不值得鼓励），则以具体属性优先级高.</p></div>
<div class="paragraph"><p>5  Beetl也可以通过[]来引用属性，如${user[“name”]} 相当于${user.name}.这跟javascript保持一致。但建议不这么做，因为容易让阅读模板的人误认为这是一个Map类型</p></div>
<div class="paragraph"><p>6 Beetl 还可以定位额外的对象属性，而无需更改java对象，这叫着虚拟属性，如，对于所有集合，数组，都有共同的虚拟熟悉size.虚拟属性是“.~”+虚拟1属性名</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">template</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="s">&quot;list&quot;</span><span class="o">,</span><span class="n">service</span><span class="o">.</span><span class="na">getUserList</span><span class="o">());</span>
<span class="n">template</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="s">&quot;pageMap&quot;</span><span class="o">,</span><span class="n">service</span><span class="o">.</span><span class="na">getPage</span><span class="o">());</span>

<span class="c1">//在模板里</span>
<span class="n">总共</span> <span class="n">$</span><span class="o">{</span><span class="n">list</span><span class="o">.~</span><span class="n">size</span><span class="o">}</span>
<span class="o">&lt;%</span>
<span class="k">for</span><span class="o">(</span><span class="n">user</span> <span class="n">in</span> <span class="n">list</span><span class="o">){</span>
<span class="o">%&gt;</span>
<span class="n">hello</span><span class="o">,</span><span class="n">$</span><span class="o">{</span><span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">};</span>


<span class="o">&lt;%}%&gt;</span>

<span class="n">当前页$</span><span class="o">{</span><span class="n">pageMap</span><span class="o">[</span><span class="err">&#39;</span><span class="n">page</span><span class="err">&#39;</span><span class="o">]},</span><span class="n">总共$</span><span class="o">{</span><span class="n">pageMap</span><span class="o">[</span><span class="s">&quot;total&quot;</span><span class="o">]}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_算数表达式">2.11. 算数表达式</h3>
<div class="paragraph"><p>Beetl支持类似javascript的算术表达式和条件表达式，如+ - * / % 以及（），以及自增++，自减--</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="s2">&quot;hi&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">a</span><span class="o">++</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">a</span><span class="o">+</span><span class="mf">100.232</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="o">+</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="nx">a</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="mf">122228833330322.1112</span><span class="nx">h</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>Beetl里定义的临时变量类型默认对应的java是Int型或者double类型，对于模板常用情况说，已经够了.如果需要定义长精度类型（对应java的BigDecimal），则需要在数字末尾加上h以表示这是长精度BigDecimal，其后的计算和输出以及逻辑表达式都将按照长精度类型来考虑。</p></div>
</div>
<div class="sect2">
<h3 id="_逻辑表达式">2.12. 逻辑表达式</h3>
<div class="paragraph"><p>Beetl支持类似Javascript,java的条件表达式 如&gt;， &lt;， == ，!=，&gt;= , &#8656; 以及 !, 还有&amp;&amp;和 || ，还有三元表达式等，如下例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">b</span><span class="o">==</span><span class="s2">&quot;good&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="o">!=</span><span class="mi">1</span><span class="o">&amp;&amp;</span><span class="nx">b</span><span class="o">==</span><span class="s2">&quot;good&quot;</span><span class="o">&amp;&amp;</span><span class="nx">c</span><span class="o">==</span><span class="kc">null</span><span class="p">){</span>
        <span class="p">......</span>
<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>三元表达式如果只考虑true条件对应的值的话，可以做简化,如下俩行效果是一样的。</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
 <span class="kd">var</span>  <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="o">%&gt;</span>
<span class="nx">$</span><span class="p">{</span><span class="nx">a</span><span class="o">==</span><span class="mi">1</span><span class="o">?</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="nx">$</span><span class="p">{</span><span class="nx">a</span><span class="o">==</span><span class="mi">1</span><span class="o">?</span><span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_循环语句">2.13. 循环语句</h3>
<div class="paragraph"><p>Beetl支持丰富的循环方式，如for-in,for(exp;exp;exp)，以及while循环，以及循环控制语句break;continue; 另外，如果没有进入for循环体，还可以执行elsefor指定的语句。</p></div>
<div class="sect3">
<h4 id="_for_in">2.13.1. for-in</h4>
<div class="paragraph"><p>for-in循环支持遍历集合对象，对于List和数组来说以及Iterator，对象就是集合对象，对于Map来说，对象就是Map.entry,如下俩个例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="k">for</span><span class="p">(</span><span class="nx">user</span> <span class="k">in</span> <span class="nx">userList</span><span class="p">){</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">userLP</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>第三行代码userLP是Beetl隐含定义的变量，能在循环体内使用。其命名规范是item名称后加上LP，他提供了当前循环的信息，如</p></div>
<div class="ulist"><ul>
<li>
<p>
userLP.index :当前的索引，从1开始
</p>
</li>
<li>
<p>
userLP.size:集合的长度
</p>
</li>
<li>
<p>
userLP.first 是否是第一个
</p>
</li>
<li>
<p>
userLP.last 是否是最后一个
</p>
</li>
<li>
<p>
userLP.even 索引是否是偶数
</p>
</li>
<li>
<p>
userLP.odd 索引是否是奇数
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>如何记住后缀是LP，有俩个诀窍，英语棒的是Loop的缩写，拼音好的是老婆的拼音缩写，这可以让程序员每次写到这的时候都会想想老婆（不管有没有，哈哈）</p></div>
</div></div>
<div class="paragraph"><p>如下是Map使用例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="k">for</span><span class="p">(</span><span class="nx">entry</span> <span class="k">in</span> <span class="nx">map</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect3">
<h4 id="_for_exp_exp_exp">2.13.2. for(exp;exp;exp)</h4>
<div class="paragraph"><p>对于渲染逻辑更为常见的是经典的for循环语句，如下例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">];</span>
<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">a</span><span class="p">.</span><span class="o">~</span><span class="nx">size</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect3">
<h4 id="_while">2.13.3. while</h4>
<div class="paragraph"><p>对于渲染逻辑同样常见的有的while循环语句，如下例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">){</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect3">
<h4 id="_elsefor">2.13.4. elsefor</h4>
<div class="paragraph"><p>不同于通常程序语言，如果没有进入循环体，则不需额外的处理，模板渲染逻辑更常见情况是如果没有进入循环体，还需要做点什么，因此，对于for循环来说，还有elsefor 用来表达如果循环体没有进入，则执行elsefor 后的语句</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span><span class="p">(</span><span class="nx">item</span> <span class="k">in</span> <span class="nx">list</span><span class="p">){</span>

<span class="p">}</span><span class="nx">elsefor</span><span class="p">{</span>
        <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;未有记录&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_条件语句">2.14. 条件语句</h3>
<div class="sect3">
<h4 id="_if_else">2.14.1. if else</h4>
<div class="paragraph"><p>同js一样，支持if else,如下例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span><span class="kc">true</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="o">&amp;&amp;</span><span class="nx">b</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>

<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span>

<span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="p">}</span>

<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect3">
<h4 id="_switch_case">2.14.2. switch-case</h4>
<div class="paragraph"><p>同js一样，支持switch-case,如下例子</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">switch</span><span class="p">(</span><span class="nx">b</span><span class="p">){</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
                <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;it&#39;s 0&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;it&#39;s 1&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
                <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">);</span>

<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>switch变量可以支持任何类型，而不像js那样只能是整形</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_select_case">2.14.3. select-case</h4>
<div class="paragraph"><p>select-case 是switch case的增强版。他允许case 里有逻辑表达式，同时，也不需要每个case都break一下，默认遇到合乎条件的case执行后就退出。</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">select</span><span class="p">(</span><span class="nx">b</span><span class="p">){</span>
        <span class="k">case</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">:</span>
                <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;it&#39;s small int&quot;</span><span class="p">);</span>
        <span class="k">case</span> <span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">:</span>
                <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;it&#39;s big int&quot;</span><span class="p">);</span>
        <span class="k">default</span><span class="o">:</span>
                <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">);</span>

<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>select 后也不需要一个变量，这样case 后的逻辑表达式将决定执行哪个case.其格式是</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">boolExp</span><span class="p">,</span><span class="nx">orBoolExp2</span><span class="o">:</span>
                <span class="nx">doSomething</span><span class="p">();</span>

<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">select</span><span class="p">{</span>
        <span class="k">case</span> <span class="nx">b</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="nx">b</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">:</span>
                <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;it&#39;s out of range&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">b</span><span class="o">==</span><span class="mi">1</span><span class="o">:</span>
                <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;it&#39;s 1&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
                <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">);</span>

<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_try_catch">2.15. try-catch</h3>
<div class="paragraph"><p>通常模板渲染逻辑很少用到try-catch 但考虑到渲染逻辑复杂性，以及模板也有不可控的地方，所以提供try catch，在渲染失败的时候仍然能保证输出正常</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="k">try</span><span class="p">{</span>
        <span class="nx">callOtherSystemView</span><span class="p">()</span>
<span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
        <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;暂时无数据&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>error代表了一个异常，你可以通过error.message 来获取可能的错误信息</p></div>
<div class="paragraph"><p>也可以省略catch部分，这样出现异常，不做任何操作</p></div>
</div>
<div class="sect2">
<h3 id="_虚拟属性">2.16. 虚拟属性</h3>
<div class="paragraph"><p>虚拟属性也是对象的属性，但是虚拟的，非模型对象的真实属性，这样的好处是当模板需要额外的用于显示的属性的时候但又不想更改模型，便可以采用这种办法
如beetl内置的虚拟属性.~size 针对了数组以及集合类型。</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">gender</span><span class="p">}</span>
<span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="o">~</span><span class="nx">genderShowName</span><span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>~genderShowName 是虚拟属性，其内部实现根据boolean变量gender来显示性别</p></div>
<div class="paragraph"><p>如何完成虚拟属性，请参考高级用法</p></div>
</div>
<div class="sect2">
<h3 id="_函数调用">2.17. 函数调用</h3>
<div class="paragraph"><p>Beetl内置了少量实用函数，可以在Beetl任何地方调用。如下例子是调用date 函数，不传参数情况下，返回当前日期</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">date</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">strutil</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="s2">&quot;cbd&quot;</span><span class="p">);</span>
<span class="nx">println</span><span class="p">(</span><span class="s2">&quot;len=&quot;</span><span class="o">+</span><span class="nx">len</span><span class="p">);</span>

<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>注意函数名支持namespace方式，因此代码第3行调用的函数是strutil.length</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>定义beetl的方法非常容易，有三种方法</p></div>
<div class="ulist"><ul>
<li>
<p>
实现Function类的call方法，并添加到配置文件里，或者显示的通过代码注册registerFunction(name,yourFunction)
</p>
</li>
<li>
<p>
可以直接调用registerFunctionPackage(namespace,yourJavaObject),这时候yourJavaObject里的所有public方法都将注册为Beetl方法，方法名是namespace+"."+方法名
</p>
</li>
<li>
<p>
可以直接写模板文件并且以html作为后缀，放到root/functions目录下，这样此模板文件自动注册为一个函数，其函数名是该模板文件名。
</p>
</li>
</ul></div>
<div class="paragraph"><p>详情请参考高级用法</p></div>
</div></div>
<div class="paragraph"><p>Beetl内置函数请参考附录，以下列出了常用的函数</p></div>
<div class="ulist"><ul>
<li>
<p>
date 返回一个java.util.Date类型的变量，如 date() 返回一个当前时间(对应java的java.util.Date); ${date( "2011-1-1" , "yyyy-MM-dd" )} 返回指定日期
</p>
</li>
<li>
<p>
print 打印一个对象  print(user.name);
</p>
</li>
<li>
<p>
println 打印一个对象以及回车换行符号，回车换号符号使用的是模板本身的，而不是本地系统的.如果仅仅打印一个换行符，则直接调用println() 即可
</p>
</li>
<li>
<p>
nvl 函数nvl，如果对象为null，则返回第二个参数，否则，返回自己  nvl(user,"不存在")
</p>
</li>
<li>
<p>
isEmpty 判断变量或者表达式是否为空，变量不存在，变量为null，变量是空字符串，变量是空集合，变量是空数组，此函数都将返回true
</p>
</li>
<li>
<p>
isNotEmpty  同上，判断对象是否不为空
</p>
</li>
<li>
<p>
has 变量名为参数，判断是否存在此全局变量，如 has(userList),类似于1.x版本的exist("userList"),但不需要输入引号了
</p>
</li>
<li>
<p>
assert 如果表达式为false，则抛出异常
</p>
</li>
<li>
<p>
trunc 截取数字，保留指定的小数位，如trunc(12.456,2) 输出是12.45
</p>
</li>
<li>
<p>
decode  一个简化的if else 结构，如 decode(a,1,"a=1",2,"a=2","不知道了")},如果a是1，这decode输出"a=1",如果a是2，则输出"a==2",
如果是其他值，则输出"不知道了"
</p>
</li>
<li>
<p>
debug 在控制台输出debug指定的对象以及所在模板文件以及模板中的行数，如debug(1),则输出1 [在3行@/org/beetl/core/lab/hello.txt],也可以输出多个，如debug("hi",a),则输出hi,a=123,[在3行@/org/beetl/core/lab/hello.txt]
</p>
</li>
<li>
<p>
parseInt 将数字或者字符解析为整形  如 parseInt("123");
</p>
</li>
<li>
<p>
parseLong 将数字或者字符解析为长整形，parseInt(123.12);
</p>
</li>
<li>
<p>
parseDouble 将数字或者字符解析为浮点类型 如parseDouble("1.23")
</p>
</li>
<li>
<p>
range 接收三个参数，初始值，结束值，还有步增（可以不需要，则默认为1），返回一个Iterator，常用于循环中，如for(var i in range(1,5)) {print(i)},将依次打印1234.
</p>
</li>
<li>
<p>
flush 强制io输出。
</p>
</li>
<li>
<p>
json，将对象转成json字符串，如 var data = json(userList)  可以跟一个序列化规则 如,var data = json(userList,"[*].id:i"),具体参考     <a href="https://git.oschina.net/xiandafu/beetl-json">https://git.oschina.net/xiandafu/beetl-json</a>
</p>
</li>
<li>
<p>
pageCtx ，仅仅在web开发中，设置一个变量，然后可以在页面渲染过程中，调用此api获取，如pageCtx("title","用户添加页面")，在其后任何地方，可以pageCtx("title") 获取该变量
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_安全输出">2.18. 安全输出</h3>
<div class="paragraph"><p>安全输出是任何一个模板引擎必须重视的问题，否则，将极大困扰模板开发者。Beetl中，如果要输出的模板变量为null，则beetl将不做输出，这点不同于JSP，JSP输出null，也不同于Feemarker，如果没有用!,它会报错.</p></div>
<div class="paragraph"><p>模板中还有俩种情况会导致模板输出异常</p></div>
<div class="ulist"><ul>
<li>
<p>
有时候模板变量并不存在（譬如子模板里）
</p>
</li>
<li>
<p>
模板变量为null，但输出的是此变量的一个属性，如${user.wife.name}
</p>
</li>
</ul></div>
<div class="paragraph"><p>针对前俩种种情况，可以在变量引用后加上！以提醒beetl这是一个安全输出的变量。</p></div>
<div class="paragraph"><p>如${user.wife.name! },即使user不存在，或者user为null，或者user.wife为null，或者user.wife.name为null beetl都不将输出</p></div>
<div class="paragraph"><p>可以在!后增加一个常量（字符串，数字类型等），或者另外一个变量，方法，本地调用，作为默认输出，譬如：</p></div>
<div class="paragraph"><p>${user.wife.name!”单身”}，如果user为null，或者user.wife为null，或者user.wife.name为null，输出”单身”</p></div>
<div class="paragraph"><p>譬如</p></div>
<div class="paragraph"><p>${user.birthday!@System.constants.DefaultBir}， 表示如果user为null，或者user. birthday为null，输出System.constants.DefaultBir</p></div>
<div class="paragraph"><p>还有一种情况很少发生，但也有可能，输出模板变量发生的任何异常，如变量内部抛出的一个异常</p></div>
<div class="paragraph"><p>这需要使用格式${!(变量)},这样，在变量引用发生任何异常情况下，都不作输出，譬如</p></div>
<div class="paragraph"><p>${!(user.name)},，beetl将会调用user.getName()方法，如果发生异常，beetl将会忽略此异常，继续渲染</p></div>
<div class="paragraph"><p>值得注意的是，在变量后加上!不仅仅可以应用于占位符输出(但主要是应用于占位符输出)，也可以用于表达式中，如：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>

<span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="o">!</span><span class="s1">&#39;N/A&#39;</span><span class="o">+</span><span class="nx">user</span><span class="p">.</span><span class="nx">age</span><span class="o">!</span><span class="p">;</span>
<span class="o">%&gt;</span>
<span class="nx">$</span><span class="p">{</span><span class="nx">k</span><span class="p">}</span>

<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如果user为null，则k值将为N/A</p></div>
<div class="paragraph"><p>在有些模板里，可能整个模板都需要安全输出，也可能模板的部分需要安全输出，使用者不必为每一个表达式使用！，可以使用beetl的安全指示符号来完成安全输出
如：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="nx">DIRECTIVE</span> <span class="nx">SAFE_OUTPUT_OPEN</span><span class="p">;</span>
<span class="o">%&gt;</span>
<span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">wife</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="nx">模板其他内容</span><span class="err">，</span><span class="nx">均能安全输出</span><span class="err">……</span>
<span class="o">&lt;%</span>
<span class="c1">//关闭安全输出。</span>
<span class="nx">DIRECTIVE</span> <span class="nx">SAFE_OUTPUT_CLOSE</span><span class="p">;</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>Beetl不建议每一个页面都使用DIRECTIVE SAFE_OUTPUT_OPEN，这样，如果如果真有不期望的错误，不容易及时发现，其次，安全输出意味着beetl会有额外的代码检测值是否存在或者是否为null，性能会略差点。所以建议及时关闭安全输出（这不是必须的，但页面所有地方是安全输出，可能不容易发现错误）</p></div>
<div class="paragraph"><p>在for-in 循环中 ，也可以为集合变量增加安全输出指示符号，这样，如果集合变量为null，也可以不进入循环体，如：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="nx">item</span> <span class="k">in</span> <span class="nx">list</span><span class="o">!</span><span class="p">){</span>

<span class="p">}</span><span class="nx">eslefor</span><span class="p">{</span>
        <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;no data&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="sect3">
<h4 id="_变量是否存在">2.18.1. 变量是否存在</h4>
<div class="paragraph"><p>判断变量是否存在，可以采用内置的has或者isEmpty方法来判断，参数是变量，如</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="k">if</span><span class="p">(</span><span class="nx">has</span><span class="p">(</span><span class="nx">flag</span><span class="p">)){</span>
        <span class="nx">print</span><span class="p">(</span><span class="s2">&quot;flag变量存在，可以访问&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如果需要判断变量是否存在，如果存在，还有其他判断条件，通常都这么写</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="k">if</span><span class="p">(</span><span class="nx">has</span><span class="p">(</span><span class="nx">flag</span><span class="p">)</span><span class="o">||</span><span class="nx">flag</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
        <span class="c1">//code</span>
<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如果flag存在，或者flag存在，但值是0，都将执行if语句</p></div>
<div class="paragraph"><p>但是，有更为简便的方法是直接用安全输出，如</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="k">if</span><span class="p">(</span><span class="nx">flag</span><span class="o">!</span><span class="mi">0</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
        <span class="c1">//code</span>
<span class="p">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>flag!0 取值是这样的，如果flag不存在，则为0，如果存在，则取值flag的值，类似三元表达式 has(flag)?falg:0</p></div>
</div>
<div class="sect3">
<h4 id="_安全输出表达式">2.18.2. 安全输出表达式</h4>
<div class="paragraph"><p>安全输出表达式可以包括</p></div>
<div class="ulist"><ul>
<li>
<p>
字符串常量,如 ${user.count!"无结果"}
</p>
</li>
<li>
<p>
boolean常量  ${user.count!false}
</p>
</li>
<li>
<p>
数字常量，仅限于正数，因为如果是负数，则类似减号，容易误用，因此，如果需要表示负数，请用括号，如${user.count!(-1)}
</p>
</li>
<li>
<p>
class直接调用，如${user.count!@User.DEFAULT_NUM}
</p>
</li>
<li>
<p>
方法调用，如 ${user.count!getDefault() }
</p>
</li>
<li>
<p>
属性引用，如 ${user.count!user.maxCount }
</p>
</li>
<li>
<p>
任何表达式，需要用括号
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_格式化">2.19. 格式化</h3>
<div class="paragraph"><p>几乎所有的模板语言都支持格式化，Beetl也不列外，如下例子Beetl提供的内置日期格式</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span> <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">date</span><span class="p">();</span> <span class="o">%&gt;</span>
<span class="nx">Today</span> <span class="nx">is</span> <span class="nx">$</span><span class="p">{</span><span class="nx">date</span><span class="p">,</span><span class="nx">dateFormat</span><span class="o">=</span><span class="s2">&quot;yyyy-MM-dd&quot;</span><span class="p">}.</span>
<span class="nx">Today</span> <span class="nx">is</span> <span class="nx">$</span><span class="p">{</span><span class="nx">date</span><span class="p">,</span><span class="nx">dateFormat</span><span class="p">}</span>
<span class="nx">salary</span> <span class="nx">is</span> <span class="nx">$</span><span class="p">{</span><span class="nx">salary</span><span class="p">,</span><span class="nx">numberFormat</span><span class="o">=</span><span class="s2">&quot;##.##&quot;</span><span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>格式化函数只需要一个字符串作为参数放在=号后面，如果没有为格式化函数输入参数，则使用默认值，dateFormat格式化函数默认值是local</p></div>
<div class="paragraph"><p>Beetl也允许为指定的java class设定格式化函数，譬如已经内置了对java.util.Date,java.sql.Date 设置了了格式化函数，因此上面的例子可以简化为</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">{</span><span class="nx">date</span><span class="p">,</span><span class="err">“</span><span class="nx">yyyy</span><span class="o">-</span><span class="nx">MM</span><span class="o">-</span><span class="nx">dd</span><span class="err">”</span><span class="p">}.</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>Beetl针对日期和数字类型提供的默认的格式化函数，在org/beetl/core/beetl-default.properties里，注册了</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="err">##</span><span class="nx">内置的格式化函数</span>
<span class="nx">FT</span><span class="p">.</span><span class="nx">dateFormat</span> <span class="o">=</span>  <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">DateFormat</span>
<span class="nx">FT</span><span class="p">.</span><span class="nx">numberFormat</span> <span class="o">=</span>  <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
<span class="err">##</span><span class="nx">内置的默认格式化函数</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nb">Date</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">DateFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nb">Date</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">DateFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nx">Time</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">DateFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nx">Timestamp</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">DateFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Short</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Long</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Integer</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Float</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Double</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">math</span><span class="p">.</span><span class="nx">BigInteger</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">math</span><span class="p">.</span><span class="nx">BigDecimal</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">concurrent</span><span class="p">.</span><span class="nx">atomic</span><span class="p">.</span><span class="nx">AtomicLong</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
<span class="nx">FTC</span><span class="p">.</span><span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">concurrent</span><span class="p">.</span><span class="nx">atomic</span><span class="p">.</span><span class="nx">AtomicInteger</span> <span class="o">=</span> <span class="nx">org</span><span class="p">.</span><span class="nx">beetl</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">NumberFormat</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_标签函数">2.20. 标签函数</h3>
<div class="paragraph"><p>所谓标签函数，即允许处理模板文件里的一块内容，功能等于同jsp tag。如Beetl内置的layout标签</p></div>
<div class="paragraph"><p>index.html</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="nx">layout</span><span class="p">(</span><span class="s2">&quot;/inc/layout.html&quot;</span><span class="p">,{</span><span class="nx">title</span><span class="o">:</span><span class="s1">&#39;主题&#39;</span><span class="p">}){</span>
<span class="o">%&gt;</span>
<span class="nx">Hello</span><span class="p">,</span><span class="k">this</span> <span class="nx">is</span> <span class="nx">main</span> <span class="nx">part</span>
<span class="o">&lt;%</span><span class="p">}</span> <span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>layout.html</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">title</span> <span class="nx">is</span> <span class="nx">$</span><span class="p">{</span><span class="nx">title</span><span class="p">}</span>
<span class="nx">body</span> <span class="nx">content</span> <span class="nx">$</span><span class="p">{</span><span class="nx">layoutContent</span><span class="p">}</span>
<span class="nx">footer</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>第1行变量title来自于layout标签函数的参数</p></div>
<div class="paragraph"><p>第2行layoutContent 是layout标签体{}渲染后的结果</p></div>
<div class="paragraph"><p>关于layout标签，参考高级主题布局</p></div>
<div class="paragraph"><p>Beetl内置了另外一个标签是include,允许 include 另外一个模板文件</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="nx">include</span><span class="p">(</span><span class="s2">&quot;/inc/header.html&quot;</span><span class="p">){}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>在标签中，{} 内容将依据标签的实现而执行，layout标签将执行{}中的内容，而include标签则忽略标签体内容。</p></div>
<div class="paragraph"><p>关于如何实现标签函数，请参考高级主题,如下是一个简单的的标签函数：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompressTag</span> <span class="kd">extends</span> <span class="n">Tag</span>
<span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">render</span><span class="o">()</span>
        <span class="o">{</span>
                <span class="n">BodyContent</span>  <span class="n">content</span> <span class="o">=</span> <span class="n">getBodyContent</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">zip</span> <span class="o">=</span> <span class="n">compress</span><span class="o">(</span><span class="n">conent</span><span class="o">);</span>
                <span class="n">ctx</span><span class="o">.</span><span class="na">byteWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">zip</span><span class="o">);</span>

        <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_html标签">2.21. HTML标签</h3>
<div class="paragraph"><p>Beetl 也支持HTML tag形式的标签， 区分beetl的html tag 与 标准html tag。如设定HTML_TAG_FLAG=#，则如下html tag将被beetl解析</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;</span><span class="err">#</span><span class="nx">footer</span> <span class="nx">style</span><span class="o">=</span><span class="err">”</span><span class="nx">simple</span><span class="err">”</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="err">#</span><span class="nx">richeditor</span> <span class="nx">id</span><span class="o">=</span><span class="err">”</span><span class="nx">rid</span><span class="err">”</span> <span class="nx">path</span><span class="o">=</span><span class="s2">&quot;${ctxPath}/upload&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="err">”</span><span class="nx">rname</span><span class="err">”</span>  <span class="nx">maxlength</span><span class="o">=</span><span class="err">”</span><span class="nx">$</span><span class="p">{</span><span class="nx">maxlength</span><span class="p">}</span><span class="err">”</span><span class="o">&gt;</span> <span class="nx">$</span><span class="p">{</span><span class="nx">html</span><span class="p">}</span> <span class="err">…</span><span class="nx">其他模板内容</span>   <span class="o">&lt;</span><span class="err">/#richdeitor&gt;</span>
<span class="o">&lt;</span><span class="err">#</span><span class="nx">html</span><span class="o">:</span><span class="nx">input</span>  <span class="nx">id</span><span class="o">=</span><span class="err">’</span><span class="nx">aaaa</span><span class="err">’</span> <span class="o">/&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如对于标签footer,Beetl默认会寻找WebRoot/htmltag/footer.tag(可以通过配置文件修改路径和后缀) ,内容如下:</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span><span class="k">if</span><span class="p">(</span><span class="nx">style</span><span class="o">==</span><span class="err">’</span><span class="nx">simple</span><span class="err">’</span><span class="p">){</span><span class="o">%&gt;</span>
 <span class="nx">请联系我</span> <span class="nx">$</span><span class="p">{</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="o">&lt;%</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="o">%&gt;</span>
<span class="nx">请联系我</span> <span class="nx">$</span><span class="p">{</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">},</span><span class="nx">phone</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">phone</span><span class="p">}</span>
<span class="o">&lt;%</span><span class="p">}</span><span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如下还包含了自定义html标签一些一些规则</p></div>
<div class="ulist"><ul>
<li>
<p>
</p>
</li>
<li>
<p>
可以在自定义标签里引用标签体的内容，标签体可以是普通文本，beetl模板，以及嵌套的自定义标签等。如上&lt;#richeditor 标签体里，可用“tagBody”来引用
</p>
</li>
<li>
<p>
HTML自定义标签 的属性值均为字符串 如&lt;#input value=”123” /&gt;,在input.tag文件里 变量value的类型是字符串
</p>
</li>
<li>
<p>
可以在属性标签里引用beetl变量，如&lt;#input value=”${user.age}” /&gt;，此时在input.tag里，value的类型取决于user.age
</p>
</li>
<li>
<p>
在属性里引用beetl变量，不支持格式化，如&lt;#input value=”${user.date,‘yyyy-MM-dd’ }” /&gt;,如果需要格式化，需要在input.tag文件里自行格式化
</p>
</li>
<li>
<p>
html tag 属性名将作为 其对应模板的变量名。
</p>
</li>
<li>
<p>
默认机制下，全局变量都将传给html tag对应的模板文件，这个跟include一样。当然，这机制也可以改变，对于标签来说，通常是作为一个组件存在，也不一定需要完全传送所有全局变量，而只传送（request,session,这样变量），因此需要重新继承org.beetl.ext.tag.HTMLTagSupportWrapper.并重载callHtmlTag方法。并注册为htmltag标签。具体请参考https://github.com/javamonkey/beetl2.0/blob/master/beetl-core/src/test/java/org/beetl/core/tag/HtmlTagTest.java
</p>
</li>
</ul></div>
<div class="paragraph"><p>如果采用模板来写html标签功能不够强大，beetl支持写标签函数（参考上一节）来实现html标签，标签函数args[0]表示标签名，这通常没有什么用处，args[1] 则是标签的属性，参数是个map，key是html tag的属性，value是其属性值，如下用java完成的html 标签用于输出属性值</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleHtmlTag</span> <span class="kd">extends</span> <span class="n">Tag</span>
<span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">render</span><span class="o">()</span>
        <span class="o">{</span>
                <span class="n">String</span> <span class="n">tagName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                <span class="n">Map</span> <span class="n">attrs</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
                <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">attrs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;attr&quot;</span><span class="o">);</span>
                <span class="k">try</span>
                <span class="o">{</span>
                        <span class="k">this</span><span class="o">.</span><span class="na">ctx</span><span class="o">.</span><span class="na">byteWriter</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span>
                <span class="o">{</span>

                <span class="o">}</span>

        <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如果注册gt.registerTag("simpleTag", SimpleHtmlTag.class);
则如下模板输出了attr属性值abc</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="err">&lt;</span>#simpleTag attr=&quot;abc&quot;&gt;<span class="err">&lt;</span>/#simpleTag&gt;
</pre></div>
</td></tr></table></div></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>HTML_TAG_FLAG默认为#用来区别是否是beetl的html tag，你也可以设置成其他符号，比如
"my:",这样，&lt;my:table&gt;&lt;/my:table&gt; 其实是一个指向table.tag的标签实现</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_绑定变量的html标签">2.22. 绑定变量的HTML标签</h3>
<div class="paragraph"><p>对于html标签（参考上一节），Beetl还 支持将标签实现类（java代码）里的对象作为临时变量，被标签体引用。此时需要实现GeneralVarTagBinding (此类是Tag的子类）
该类提供另外3个个方法
-  void binds(Object&#8230; array)    子类在render方法里调用此类以实现变量绑定，绑定顺序同在模板中申明的顺序
-  void bind(String name, Object value)    子类在render方法里调用此类以实现变量绑定，name是模板中申明的变量名，用此方法绑定不如binds更灵活，不再推荐
-  Object getAttributeValue 获得标签的属性
-  Map getAttributes 获得标签的所有属性</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TagSample</span> <span class="kd">extends</span> <span class="n">GeneralVarTagBinding</span>
<span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">render</span><span class="o">()</span>
        <span class="o">{</span>
                <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">getAttributeValue</span><span class="o">(</span><span class="s">&quot;limit&quot;</span><span class="o">));</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="o">{</span>
                        <span class="k">this</span><span class="o">.</span><span class="na">binds</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
                        <span class="k">this</span><span class="o">.</span><span class="na">doBodyRender</span><span class="o">();</span>
                <span class="o">}</span>

        <span class="o">}</span>

<span class="o">}</span>


<span class="c1">//在某处注册一下标签TagSample</span>
<span class="c1">//gt.registerTag(&quot;tag&quot;, TagSample.class);</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如上例子，render方法将循环渲染标签体limit次，且每次都将value赋值为i。我们再看看模板如何写的</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre> <span class="err">&lt;</span>#tag limit=&quot;3&quot; ; value&gt;
        ${value}
 <span class="err">&lt;</span>/#tag&gt;
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>类似于常规html标签，需要在标签的最后的属性定义后面加上分号 ";" 此分号表示这个是一个需要在标签运行时需要绑定变量的标签。后跟上要绑定的变量列表，如上例只绑定了一个value变量，如果需要绑定多个变量，则用逗号分开，如var1,var2 上。如果后面没有变量列表，只有分号，则默认绑定到标签名同名的变量上. 如果标签有namesapce，则默认绑定订的变量名不包含namespace</p></div>
<div class="paragraph"><p>注意，由于标签使用因为太长可能换行或者是文本格式化导致换行，目前beetl只允许在属性之间换行，否则，将报标签解析错误。</p></div>
<div class="paragraph"><p>默认情况下，如果标签属性出现了var(可以通过配置文件改成其他属性名)，也认为是绑定变量的标签，如上面的例子也可以这么写</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre> <span class="err">&lt;</span>#tag limit=&quot;3&quot; var=&quot;value&quot;&gt;
        ${value}
 <span class="err">&lt;</span>/#tag&gt;
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>var属性的值可以是个以逗号分开的变量名列表，如var="total,customer,index"</p></div>
</div>
<div class="sect2">
<h3 id="_直接调用java方法和属性">2.23. 直接调用java方法和属性</h3>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">{</span><span class="err">@</span><span class="nx">user</span><span class="p">.</span><span class="nx">getMaxFriend</span><span class="p">(</span><span class="err">“</span><span class="nx">lucy</span><span class="err">”</span><span class="p">)}</span>
<span class="nx">$</span><span class="p">{</span><span class="err">@</span><span class="nx">user</span><span class="p">.</span><span class="nx">maxFriend</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">getName</span><span class="p">()}</span>
<span class="nx">$</span><span class="p">{</span><span class="err">@</span><span class="nx">com</span><span class="p">.</span><span class="nx">xxxx</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">Order</span><span class="p">.</span><span class="nx">getMaxNum</span><span class="p">()}</span>
<span class="nx">$</span><span class="p">{</span><span class="err">@</span><span class="nx">com</span><span class="p">.</span><span class="nx">xxxx</span><span class="p">.</span><span class="nx">User$Gender</span><span class="p">.</span><span class="nx">MAN</span><span class="p">}</span>
<span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">max</span> <span class="o">=</span> <span class="err">@</span><span class="nx">com</span><span class="p">.</span><span class="nx">xxxx</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">Order</span><span class="p">.</span><span class="nx">MAX_NUM</span><span class="p">;</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>可以调用instance的public方法和属性，也可以调用静态类的属性和方法 ,需要加一个  @指示此调用是直接调用class，其后的表达式是java风格的。</p></div>
<div class="sidebarblock">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
GroupTemplate可以配置为不允许直接调用Class，具体请参考配置文件.
</p>
</li>
<li>
<p>
也可以通过安全管理器配置到底哪些类Beetl不允许调用，具体请参考高级用法。默认情况，java.lang.Runtime,和 java.lang.Process不允许在模板里调用。你自己的安全管理器也许可以配置为不能直接访问DAO类（避免了以前jsp可以访问任意代码带来的危害）
</p>
</li>
<li>
<p>
请按照java规范写类名和方法名，属性名。这样便于beetl识别到底调用的是哪个类，哪个方法。否则会抛出错误
</p>
</li>
<li>
<p>
可以省略包名，只用类名。beetl将搜索包路径找到合适的类（需要设置配置“IMPORT_PACKAGE=包名.;包名.”，包名后需要跟一个“.”, 或者调用Configuration.addPkg)方法具体请参考附件配置文件说明
</p>
</li>
<li>
<p>
内部类（包括枚举）访问同java一样，如User类有个内部枚举类Gender，访问是User$Gender
</p>
</li>
</ul></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_严格mvc控制">2.24. 严格MVC控制</h3>
<div class="paragraph"><p>如果在配置文件中设置了严格MVC，则以下语法将不在模板文件里允许，否则将报出STRICK_MVC 错误</p></div>
<div class="ulist"><ul>
<li>
<p>
定义变量，为变量赋值,如var a = 12是非法的
</p>
</li>
<li>
<p>
算术表达式 如${user.age+12}是非法的
</p>
</li>
<li>
<p>
除了只允许布尔以外，不允许逻辑表达式和方法调用 如if(user.gender==1)是非法的
</p>
</li>
<li>
<p>
方法调用，如${subString(string,1)}是非法的
</p>
</li>
<li>
<p>
Class方法和属性调用，如${@user.getName()}是非法的
</p>
</li>
<li>
<p>
严格的MVC，非常有助于逻辑与视图的分离，特别当逻辑与视图是由俩个团队来完成的。如果你嗜好严格MVC，可以调用groupTemplate.enableStrict()
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>通过重载AntlrProgramBuilder，可以按照自己的方法控制到底哪些语法是不允许在模板引擎中出现的，但这已经超出了Beetl模板的基础使用</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_指令">2.25. 指令</h3>
<div class="paragraph"><p>指令格式为： DIRECTIVE 指令名 指令参数（可选）
Beetl目前支持安全输出指令，分别是</p></div>
<div class="ulist"><ul>
<li>
<p>
DIRECTIVE SAFE_OUTPUT_OPEN ; 打开安全输出功能，此指令后的所有表达式都具有安全输出功能，
</p>
</li>
<li>
<p>
DIRECTIVE SAFE_OUTPUT_CLOSE ; 关闭安全输出功能。详情参考安全输出
</p>
</li>
<li>
<p>
DIRECTIVE DYNAMIC varName1,varName2 &#8230;指示后面的变量是动态类型，Beetl应该考虑为Object. 也可以省略后面的变量名，则表示模板里所有变量都是Object
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span> <span class="nx">DIRECTIVE</span> <span class="nx">DYNAMIC</span> <span class="nx">idList</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="nx">value</span> <span class="k">in</span> <span class="nx">idList</span><span class="p">)</span> <span class="p">.....</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>DYNAMIC 通常用在组件模板里，因为组件模板可以接收任何类型的对象。如列表控件，可以接收任何含有id和 value属性的对象。</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>1 注意 DYNAMIC 后的变量名也允许用引号，这主要是兼容Beetl1.x版本</p></div>
<div class="paragraph"><p>2  Beetl1.x 指令都是大写，当前版本也允许小写，如 directive dynamic idList</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_类型声明">2.26. 类型声明</h3>
<div class="paragraph"><p>Beetl 本质上还是强类型的模板引擎，即模板每个变量类型是特定的，在模板运行过程中，beetl 会根据全局变量自动推测出模板中各种变量和表达式类型。
也可以通过类型申明来说明beetl全局变量的类型，如下格式</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="cm">/**</span>
<span class="cm">*@type (List&lt;User&gt; idList,User user)</span>
<span class="cm">*/</span>
<span class="k">for</span><span class="p">(</span><span class="nx">value</span> <span class="k">in</span> <span class="nx">idList</span><span class="p">)</span> <span class="p">.....</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>类型申明必须放到多行注释里，格式是@type( &#8230; ),里面的申明类似java方法的参数申明。正如你看到的类型申明是在注释里，也就表明了这在Beetl模板引擎中不是必须的，或者你只需要申明一部分即可，之所以提供可选的类型说明，是因为</p></div>
<div class="ulist"><ul>
<li>
<p>
提高一点性能
</p>
</li>
<li>
<p>
最重要的是，提高了模板的可维护性。可以让模板维护者知道变量类型，也可以让未来的ide插件根据类型声明来提供属性提示，重构等高级功能
</p>
</li>
</ul></div>
<div class="paragraph"><p>需要注意的是，如果在类型声明里提供的是类名，而不是类全路径，这样必须在配置文件里申明类的搜索路径(（需要设置配置IMPORT_PACKAGE=包名.;包名.，或者调用Configuration.addPkg))，默认的搜索路径有java.util. 和 java.lang.</p></div>
</div>
<div class="sect2">
<h3 id="_错误处理">2.27. 错误处理</h3>
<div class="paragraph"><p>Beetl能较为详细的显示错误原因，包括错误行数，错误符号，错误内容附近的模板内容，以及错误原因，如果有异常，还包括异常和异常信息。
默认情况下，仅仅在控制台显示，如下代码：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="o">/</span><span class="mi">0</span><span class="p">;</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>运行此模板后，错误提示如下：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&gt;&gt;</span><span class="nx">DIV_ZERO_ERROR</span><span class="o">:</span><span class="mi">0</span> <span class="nx">位于3行</span> <span class="nx">资源</span><span class="o">:</span><span class="err">/org/beetl/sample/s0125/error1.txt</span>
<span class="mi">1</span><span class="o">|&lt;%</span>
<span class="mi">2</span><span class="o">|</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">3</span><span class="o">|</span><span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="o">/</span><span class="mi">0</span><span class="p">;</span>
<span class="mi">4</span><span class="o">|%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span>
<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">a</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>运行此模板后</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&gt;&gt;</span><span class="nx">缺少符号</span><span class="p">(</span><span class="nx">PARSER_MISS_ERROR</span><span class="p">)</span><span class="o">:</span><span class="nx">缺少输入</span> <span class="s1">&#39;;&#39;</span> <span class="nx">在</span> <span class="s1">&#39;var&#39;</span> <span class="nx">位于4行</span> <span class="nx">资源</span><span class="o">:</span><span class="err">/org/beetl/sample/s0125/error2.txt</span>
<span class="mi">1</span><span class="o">|&lt;%</span>
<span class="mi">2</span><span class="o">|</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">3</span><span class="o">|</span><span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span>
<span class="mi">4</span><span class="o">|</span><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">a</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
<span class="mi">5</span><span class="o">|%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>1 默认的错误处理器仅仅像后台打印错误，并没有抛出异常，如果需要在render错误时候抛出异常到控制层，则可以使用org.beetl.core.ReThrowConsoleErrorHandler。不仅打印异常，还抛出BeetlException，</p></div>
<div class="paragraph"><p>2  可以自定义异常处理器，比如把错误输出到 作为渲染结果一部分输出，或者输出更美观的html内容等，具体参考高级用法</p></div>
<div class="paragraph"><p>3 可以在配置文件不设置异常，这样Beetl引擎将不处理异常，用户可以在外部来处理（可以在外部调用ErrorHandler子类来显示异常）</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_beetl小工具">2.28. Beetl小工具</h3>
<div class="paragraph"><p>BeetlKit 提供了一些便利的方法让你立刻能使用Beetl模板引擎。提供了如下方法</p></div>
<div class="ulist"><ul>
<li>
<p>
public static String render(String template, Map&lt;String, Object&gt; paras)
渲染模板，使用paras参数，渲染结果作为字符串返回
</p>
</li>
<li>
<p>
public static void renderTo(String template, Writer writer, Map&lt;String, Object&gt; paras)
渲染模板，使用paras参数，渲染结果作为字符串返回
</p>
</li>
<li>
<p>
public static void execute(String script, Map&lt;String, Object&gt; paras)
执行某个脚本
</p>
</li>
<li>
<p>
public static Map execute(String script, Map&lt;String, Object&gt; paras, String[] locals)
执行某个脚本，将locals指定的变量名和模板执行后相应值放入到返回的Map里
</p>
</li>
<li>
<p>
public static Map executeAndReturnRootScopeVars(String script)
执行某个脚本，返回所有顶级scope的所有变量和值
</p>
</li>
<li>
<p>
public static String testTemplate(String template, String initValue)
渲染模板template，其变量来源于intValue脚本运行的结果，其所有顶级Scope的变量都将作为template的变量
</p>
</li>
<li>
<p>
public static String testTemplate(String template, String initValue)
渲染模板template，其变量来源于intValue脚本运行的结果，其所有顶级Scope的变量都将作为template的变量
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">String</span> <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;var a=1,c=2+1;&quot;</span><span class="o">;</span>
<span class="n">Map</span> <span class="n">result</span> <span class="o">=</span> <span class="n">executeAndReturnRootScopeVars</span><span class="o">(</span><span class="n">template</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
<span class="c1">//输出结果是{c=3, a=1}</span>
</pre></div>
</td></tr></table></div></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>BeetlKit　不要用于线上系统。仅仅作为体验Beetl功能而提供的，如果需要在线上使用这些功能，请参考该类源码自行扩展</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_变量不存在">2.29. 变量不存在</h3>
<div class="paragraph"><p>对于编程语言来说，变量不存在则在编译期就会报错，对于那种解释语言，变量也是要么存在，要么不存在，不可能一段代码里有俩种情况，但对于模板语言来说，一段模板里的变量可能有这俩种状态，如新增和修改共用一个模板文件就会出现这种情况。如果变量有可能不存在，则用安全输出符号"!"，如下代码：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;span&gt;</span>${user.name!}<span class="nt">&lt;/span&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>对于逻辑表达式，也可以使用安全输出符号，如:</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="k">if</span><span class="o">(</span><span class="kc">null</span><span class="o">==</span><span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">!)</span> <span class="c1">//安全输出符号后如果未有表达式，则返回null</span>
<span class="k">if</span><span class="o">(</span><span class="err">&#39;&#39;</span><span class="o">==</span><span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">!</span><span class="err">&#39;&#39;</span><span class="o">)</span> <span class="c1">//如果user.name不存在或者为null，则返回空字符串。或者user.name本身是空字符串</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>系统提供了一些函数，也可以用于判断变量是否存在</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">&lt;%</span>
<span class="k">if</span><span class="o">(</span><span class="n">has</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>   <span class="c1">//接受一个变量名,如果存在user变量,返回true</span>
<span class="k">if</span><span class="o">(</span><span class="n">isEmpty</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">)</span>
<span class="cm">/*</span>
<span class="cm">如果user不存在，或者为null，或者user.name是空为null，</span>
<span class="cm">或者user.name是空字符串，都返回true</span>
<span class="cm">*/</span>
<span class="k">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>isEmtpy 可以接受表达式，可以判断集合，数组，字符串为空情况，详细参考该函数说明</p></div>
</div>
<div class="sect2">
<h3 id="_琐碎功能">2.30. 琐碎功能</h3>
<div class="ulist"><ul>
<li>
<p>
对齐:我发现别的模板语言要是做到对齐，非常困难,使用Beetl你完全不用担心，比如velocty，stringtemlate，freemarker例子都出现了不对齐的情况，影响了美观，Beetl完全无需担心输出对齐
</p>
</li>
<li>
<p>
Escape:可以使用\ 做escape 符号，如\$monkey\$ 将作为一个普通的文本，输出为$monkey$.再如为了在后加上美元符号（占位符恰好又是美元符号）可以用这俩种方式hello,it&#8217;s
$money$\$, 或者Hello,it&#8217;s $money+"\$"$ 。如果要输出\符号本生，则需要用俩个\\,这点与javascript，java 语义一致.
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_高级用法">3. 高级用法</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_配置grouptemplate">3.1. 配置GroupTemplate</h3>
<div class="paragraph"><p>Beetl建议通过配置文件配置配置GroupTemplate，主要考虑到未来可能IDE插件会支持Beetl模板，模板的属性，和函数等如果能通过配置文件获取，将有助于IDE插件识别。 配置GroupTemplate有俩种方法</p></div>
<div class="ulist"><ul>
<li>
<p>
配置文件： 默认配置在/org/beetl/core/beetl-default.properties 里，Beetl首先加载此配置文件，然后再加载classpath里的beetl.properties,并用后者覆盖前者。配置文件通过Configuration类加载，因此加载完成后，也可以通过此类API来修改配置信息
</p>
</li>
<li>
<p>
通过调用GroupTemplate提供的方法来注册函数，格式化函数，标签函数等
</p>
</li>
</ul></div>
<div class="paragraph"><p>配置文件分为三部分，第一部分是基本配置，在第一节讲到过。第二部分是资源类配置，可以在指定资源加载类，以及资源加载器的属性，如下</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">RESOURCE_LOADER</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">ClasspathResourceLoader</span>
<span class="err">#</span><span class="n">资源配置</span><span class="err">，</span><span class="n">resource后的属性只限于特定ResourceLoader</span>
<span class="err">#</span><span class="n">classpath</span> <span class="n">根路径</span>
<span class="n">RESOURCE</span><span class="o">.</span><span class="na">root</span><span class="o">=</span> <span class="o">/</span>
<span class="err">#</span><span class="n">是否检测文件变化</span>
<span class="n">RESOURCE</span><span class="o">.</span><span class="na">autouCheck</span><span class="o">=</span> <span class="kc">true</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>第一行指定了类加载器，第二行指定了模板根目录的路径，此处/ 表示位于classpath 根路径下，第三行是否自动检测模板变化，默认为true，开发环境下自动检测模板是否更改。关于如何如何自定义ResouceLoader，请参考下一章</p></div>
<div class="paragraph"><p>配置文件第三部分是扩展部分，如方法，格式化函数等</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="err">#####</span>  <span class="n">扩展</span> <span class="err">##############</span>
<span class="err">##</span> <span class="n">内置的方法</span>
<span class="n">FN</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">fn</span><span class="o">.</span><span class="na">DateFunction</span>
<span class="n">FN</span><span class="o">.</span><span class="na">nvl</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">fn</span><span class="o">.</span><span class="na">NVLFunction</span>
<span class="o">.................</span>
<span class="err">##</span><span class="n">内置的功能包</span>
<span class="n">FNP</span><span class="o">.</span><span class="na">strutil</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">fn</span><span class="o">.</span><span class="na">StringUtil</span>

<span class="err">##</span><span class="n">内置的格式化函数</span>
<span class="n">FT</span><span class="o">.</span><span class="na">dateFormat</span> <span class="o">=</span>  <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">format</span><span class="o">.</span><span class="na">DateFormat</span>
<span class="n">FT</span><span class="o">.</span><span class="na">numberFormat</span> <span class="o">=</span>  <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">format</span><span class="o">.</span><span class="na">NumberFormat</span>
<span class="o">.................</span>

<span class="err">##</span><span class="n">内置的默认格式化函数</span>
<span class="n">FTC</span><span class="o">.</span><span class="na">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Date</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">format</span><span class="o">.</span><span class="na">DateFormat</span>
<span class="n">FTC</span><span class="o">.</span><span class="na">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Date</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">format</span><span class="o">.</span><span class="na">DateFormat</span>

<span class="err">##</span> <span class="n">标签类</span>
<span class="n">TAG</span><span class="o">.</span><span class="na">include</span><span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">tag</span><span class="o">.</span><span class="na">IncludeTag</span>
<span class="n">TAG</span><span class="o">.</span><span class="na">includeFileTemplate</span><span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">tag</span><span class="o">.</span><span class="na">IncludeTag</span>
<span class="n">TAG</span><span class="o">.</span><span class="na">layout</span><span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">tag</span><span class="o">.</span><span class="na">LayoutTag</span>
<span class="n">TAG</span><span class="o">.</span><span class="na">htmltag</span><span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">tag</span><span class="o">.</span><span class="na">HTMLTagSupportWrapper</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>FN前缀表示Function，FNP前缀表示FunctionPackage，FT表示format函数，FTC表示类的默认Format函数，TAG表示标签类。Beetl强烈建议通过配置文件加载扩展。以便随后IDE插件能识别这些注册函数</p></div>
</div>
<div class="sect2">
<h3 id="_自定义方法">3.2. 自定义方法</h3>
<div class="sect3">
<h4 id="_实现function">3.2.1. 实现Function</h4>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Print</span> <span class="kd">implements</span> <span class="n">Function</span>
<span class="o">{</span>

        <span class="kd">public</span> <span class="n">String</span> <span class="nf">call</span><span class="o">(</span><span class="n">Object</span><span class="o">[]</span> <span class="n">paras</span><span class="o">,</span> <span class="n">Context</span> <span class="n">ctx</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">paras</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="o">{</span>
                        <span class="k">try</span>
                        <span class="o">{</span>
                                <span class="n">ctx</span><span class="o">.</span><span class="na">byteWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                        <span class="o">}</span>
                        <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span>
                        <span class="o">{</span>
                                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                        <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>

        <span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>call方法有俩个参数，第一个是数组，这是由模板传入的，对应着模板的参数，第二个是Context，包含了模板的上下文，主要提供了如下属性</p></div>
<div class="ulist"><ul>
<li>
<p>
byteWriter 输出流
</p>
</li>
<li>
<p>
template 模板本身
</p>
</li>
<li>
<p>
gt GroupTemplate
</p>
</li>
<li>
<p>
globalVar 该模板对应的全局变量
</p>
</li>
<li>
<p>
byteOutputMode 模板的输出模式，是字节还是字符
</p>
</li>
<li>
<p>
safeOutput 模板当前是否处于安全输出模式
</p>
</li>
<li>
<p>
其他属性建议不熟悉的开发人员不要乱动
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>1 call方法要求返回一个Object，如果无返回，返回null即可</p></div>
<div class="paragraph"><p>2 为了便于类型判断，call方法最好返回一个具体的类，如date函数返回的就是java.util.Date</p></div>
<div class="paragraph"><p>3 call方法里的任何异常应该抛出成Runtime异常</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_使用普通的java类">3.2.2. 使用普通的java类</h4>
<div class="paragraph"><p>尽管实现Function对于模板引擎来说，是效率最高的方式，但考虑到很多系统只有util类，这些类里的方法仍然可以注册为模板函数。其规则很简单，就是该类的所有public方法。如果需还要Context 变量，则需要在方法最后一个参数加上Context即可，如</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">util</span>
<span class="o">{</span>

        <span class="kd">public</span> <span class="n">String</span> <span class="nf">print</span><span class="o">(</span><span class="n">Object</span> <span class="n">a</span><span class="o">,</span> <span class="n">Context</span> <span class="n">ctx</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="o">...............</span>

        <span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>注意</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>1 从beetl效率角度来讲，采用普通类效率不如实现Function调用</p></div>
<div class="paragraph"><p>2 采用的普通java类尽量少同名方法。这样效率更低。beetl调用到第一个适合的同名方法。而不像java那样找到最匹配的</p></div>
<div class="paragraph"><p>3 方法名支持可变数组作为参数</p></div>
<div class="paragraph"><p>4 方法名最后一个参数如果是Context，则beetl会传入这个参数。</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_使用模板文件作为方法">3.2.3. 使用模板文件作为方法</h4>
<div class="paragraph"><p>可以不用写java代码，模板文件也能作为一个方法。默认情况下，需要将模板文件放到Root的functions目录下，且扩展名为.html(可以配置文件属性来修改此俩默认值)
方法参数分别是para0,para1&#8230;..</p></div>
<div class="paragraph"><p>如下root/functions/page.fn</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="c1">//para0,para1 由函数调用传入</span>
<span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">para0</span><span class="p">,</span><span class="nx">total</span> <span class="o">=</span> <span class="nx">para1</span><span class="p">,</span><span class="nx">style</span><span class="o">=</span><span class="nx">para2</span><span class="o">!</span><span class="s1">&#39;simple&#39;</span>
<span class="o">%&gt;</span>
<span class="nx">当前页面</span> <span class="nx">$</span><span class="p">{</span><span class="nx">current</span><span class="p">},</span><span class="nx">总共$</span><span class="p">{</span><span class="nx">total</span><span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>则在模板中</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="nx">page</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span><span class="nx">total</span><span class="p">);</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>允许使用return 表达式返回一个变量给调用者，如模板文件functions\now.html</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
        <span class="k">return</span> <span class="nx">date</span><span class="p">();</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>在任何模板里都可以调用：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">hello</span> <span class="nx">time</span> <span class="nx">is</span> <span class="nx">$</span><span class="p">{</span><span class="nx">now</span><span class="p">(),</span><span class="err">‘</span><span class="nx">yyyy</span><span class="o">-</span><span class="nx">MM</span><span class="o">-</span><span class="nx">dd</span><span class="err">’</span><span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>也可以在functions建立子目录，这样function则具有namespace，其值就是文件夹名</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_自定义格式化函数">3.3. 自定义格式化函数</h3>
<div class="paragraph"><p>需要实现Format接口</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="kr">public</span> <span class="kr">class</span> <span class="nx">DateFormat</span> <span class="kr">implements</span> <span class="nx">Format</span>
<span class="p">{</span>

        <span class="kr">public</span> <span class="nb">Object</span> <span class="nx">format</span><span class="p">(</span><span class="nb">Object</span> <span class="nx">data</span><span class="p">,</span> <span class="nb">String</span> <span class="nx">pattern</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="kr">class</span><span class="p">.</span><span class="nx">isAssignableFrom</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">getClass</span><span class="p">()))</span>
                <span class="p">{</span>
                        <span class="nx">SimpleDateFormat</span> <span class="nx">sdf</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">pattern</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="nx">sdf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SimpleDateFormat</span><span class="p">();</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                                <span class="nx">sdf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SimpleDateFormat</span><span class="p">(</span><span class="nx">pattern</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nx">sdf</span><span class="p">.</span><span class="nx">format</span><span class="p">((</span><span class="nb">Date</span><span class="p">)</span> <span class="nx">data</span><span class="p">);</span>

                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">&quot;Arg Error:Type should be Date&quot;</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>data 参数表示需要格式化的对象，pattern表示格式化模式，开发时候需要考虑pattern为null的情况</p></div>
<div class="paragraph"><p>也可以实现ContextFormat 类抽象方法，从而得到Context，获取外的格式化信息。</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>        <span class="kr">public</span> <span class="kr">abstract</span> <span class="nb">Object</span> <span class="nx">format</span><span class="p">(</span><span class="nb">Object</span> <span class="nx">data</span><span class="p">,</span><span class="nb">String</span> <span class="nx">pattern</span><span class="p">,</span><span class="nx">Context</span> <span class="nx">ctx</span><span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_自定义标签">3.4. 自定义标签</h3>
<div class="paragraph"><p>标签形式有俩种，一种是标签函数，第二种是html tag。第二种实际上在语法解析的时候会转化成第一种，其实现是HTMLTagSupportWrapper，此类将会寻找root/htmltag目录下同名的标签文件作为模板来执行。类似普通模板一样，在此就不详细说了</p></div>
<div class="sect3">
<h4 id="_标签函数_2">3.4.1. 标签函数</h4>
<div class="paragraph"><p>标签函数类似jsp2.0的实现方式，需要实现Tag类的render方法即可</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="kr">public</span> <span class="kr">class</span> <span class="nx">DeleteTag</span> <span class="kr">extends</span> <span class="nx">Tag</span>
<span class="p">{</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="k">void</span> <span class="nx">render</span><span class="p">()</span>
        <span class="p">{</span>
                <span class="c1">// do nothing,just ignore body</span>
                <span class="nx">ctx</span><span class="p">.</span><span class="nx">byteWriter</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;被删除了，付费可以看&quot;</span><span class="p">)</span>

        <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如上一个最简单的Tag，将忽略tag体，并输出内容</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="kr">public</span> <span class="kr">class</span> <span class="nx">XianDeDantengTag</span> <span class="kr">extends</span> <span class="nx">Tag</span>
<span class="p">{</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="k">void</span> <span class="nx">render</span><span class="p">()</span>
        <span class="p">{</span>
                <span class="nx">doBodyRender</span><span class="p">();</span>

        <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>此类将调用父类方法doBodyRender，渲染tag body体</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="kr">public</span> <span class="kr">class</span> <span class="nx">CompressTag</span> <span class="kr">extends</span> <span class="nx">Tag</span>
<span class="p">{</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="k">void</span> <span class="nx">render</span><span class="p">()</span>
        <span class="p">{</span>
                <span class="nx">BodyContent</span>  <span class="nx">content</span> <span class="o">=</span> <span class="nx">getBodyContent</span><span class="p">();</span>
                <span class="nb">String</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>
                <span class="nb">String</span> <span class="nx">zip</span> <span class="o">=</span> <span class="nx">compress</span><span class="p">(</span><span class="nx">conent</span><span class="p">);</span>
                <span class="nx">ctx</span><span class="p">.</span><span class="nx">byteWriter</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">zip</span><span class="p">);</span>

        <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>此类将调用父类方法getBodyContent ，获得tag body后压缩输出</p></div>
<div class="paragraph"><p>tag类提供了如下属性和方法供使用</p></div>
<div class="ulist"><ul>
<li>
<p>
args  传入标签的参数
</p>
</li>
<li>
<p>
gt GroupTemplate
</p>
</li>
<li>
<p>
ctx  Context
</p>
</li>
<li>
<p>
bw   当前的输出流
</p>
</li>
<li>
<p>
bs  标签体对应的语法树，不熟悉勿动
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_自定义虚拟属性">3.5. 自定义虚拟属性</h3>
<div class="paragraph"><p>可以为特定类注册一个虚拟属性，也可以为一些类注册虚拟属性</p></div>
<div class="ulist"><ul>
<li>
<p>
public void registerVirtualAttributeClass(Class cls, VirtualClassAttribute virtual) 实现VirtualClassAttribute方法可以为特定类注册一个需要属性，如下代码：
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">gt</span><span class="p">.</span><span class="nx">registerVirtualAttributeClass</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="kr">class</span><span class="p">,</span> <span class="k">new</span> <span class="nx">VirtualClassAttribute</span><span class="p">()</span> <span class="p">{</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="nb">String</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">Object</span> <span class="nx">o</span><span class="p">,</span> <span class="nb">String</span> <span class="nx">attributeName</span><span class="p">,</span> <span class="nx">Context</span> <span class="nx">ctx</span><span class="p">)</span>
        <span class="p">{</span>

                <span class="nx">User</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">(</span><span class="nx">User</span><span class="p">)</span> <span class="nx">o</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">attributeName</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="s2">&quot;ageDescritpion&quot;</span><span class="p">)){</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">getAge</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
                        <span class="p">{</span>
                                <span class="k">return</span> <span class="s2">&quot;young&quot;</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                                <span class="k">return</span> <span class="s2">&quot;old&quot;</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>


        <span class="p">}</span>

<span class="p">});</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>User类的所有虚拟属性将执行eval方法，此方法根据年纪属性来输出对应的描述。</p></div>
<div class="ulist"><ul>
<li>
<p>
public void registerVirtualAttributeEval(VirtualAttributeEval e) 为一些类注册需要属性，VirtualAttributeEval.isSupport方法将判断是否应用虚拟属性到此类
</p>
</li>
</ul></div>
<div class="paragraph"><p>如下是虚拟属性类的定义</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">VirtualClassAttribute</span>
<span class="o">{</span>
        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">String</span> <span class="n">attributeName</span><span class="o">,</span> <span class="n">Context</span> <span class="n">ctx</span><span class="o">);</span>

<span class="o">}</span>


<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">VirtualAttributeEval</span> <span class="kd">extends</span> <span class="n">VirtualClassAttribute</span>
<span class="o">{</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSupport</span><span class="o">(</span><span class="n">Class</span> <span class="n">c</span><span class="o">,</span> <span class="n">String</span> <span class="n">attributeName</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_使用额外的资源加载器">3.6. 使用额外的资源加载器</h3>
<div class="paragraph"><p>某些情况下，模板来源不止一处，GroupTemplate配置了一个默认的资源加载器，如果通过gt.getTemplate(key),将调用默认的ResourceLoader，获取模板内容，然后转化为beetl脚本放入到缓存里。你也可以传入额外的资源管理器加载模板，通过调用gt.getTemplate(key,otherLoader)来完成;</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">GroupTemplate</span> <span class="n">gt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroupTemplate</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span><span class="n">fileLoader</span><span class="o">)</span>
<span class="c1">//自定义，参考下一节</span>
<span class="n">MapResourceLoader</span> <span class="n">dbLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MapResourceLoader</span><span class="o">(</span><span class="n">getData</span><span class="o">());</span>
<span class="n">Template</span> <span class="n">t</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="s">&quot;db:1&quot;</span><span class="o">,</span> <span class="n">dbLoader</span><span class="o">);</span>

<span class="kd">private</span> <span class="n">Map</span> <span class="nf">getData</span><span class="o">()</span>
<span class="o">{</span>
        <span class="n">Map</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">data</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;db:1&quot;</span><span class="o">,</span> <span class="s">&quot;${a}&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>对于更复杂的模板资源来源，也可以自定义一个资源加载来完成，参考下一节</p></div>
</div>
<div class="sect2">
<h3 id="_自定义资源加载器">3.7. 自定义资源加载器</h3>
<div class="paragraph"><p>如果模板资源来自其他地方，如数据库，或者混合了数据库和物理文件，或者模板是加密的，则需要自定义一个资源加载器。资源加载器需要实现ResourceLoader类。如下：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span class="kr">public</span> <span class="kr">interface</span> <span class="nx">ResourceLoader</span>
<span class="p">{</span>

        <span class="cm">/**</span>
<span class="cm">         * 根据key获取Resource</span>
<span class="cm">         *</span>
<span class="cm">         * @param key</span>
<span class="cm">         * @return</span>
<span class="cm">         */</span>
        <span class="kr">public</span> <span class="nx">Resource</span> <span class="nx">getResource</span><span class="p">(</span><span class="nb">String</span> <span class="nx">key</span><span class="p">);</span>

        <span class="cm">/** 检测模板是否更改，每次渲染模板前，都需要调用此方法，所以此方法不能占用太多时间，否则会影响渲染功能</span>
<span class="cm">         * @param key</span>
<span class="cm">         * @return</span>
<span class="cm">         */</span>
        <span class="kr">public</span> <span class="kr">boolean</span> <span class="nx">isModified</span><span class="p">(</span><span class="nx">Resource</span> <span class="nx">key</span><span class="p">);</span>

        <span class="cm">/**</span>
<span class="cm">         * 关闭ResouceLoader，通常是GroupTemplate关闭的时候也关闭对应的ResourceLoader</span>
<span class="cm">         */</span>
        <span class="kr">public</span> <span class="k">void</span> <span class="nx">close</span><span class="p">();</span>

        <span class="cm">/** 一些初始化方法</span>
<span class="cm">         * @param gt</span>
<span class="cm">         */</span>
        <span class="kr">public</span> <span class="k">void</span> <span class="nx">init</span><span class="p">(</span><span class="nx">GroupTemplate</span> <span class="nx">gt</span><span class="p">);</span>

        <span class="cm">/**  用于include，layout等根据相对路径计算资源实际的位置.</span>
<span class="cm">         * @param resource 当前资源</span>
<span class="cm">         * @param key</span>
<span class="cm">         * @return</span>
<span class="cm">         */</span>
        <span class="kr">public</span> <span class="nb">String</span> <span class="nx">getResourceId</span><span class="p">(</span><span class="nx">Resource</span> <span class="nx">resource</span><span class="p">,</span> <span class="nb">String</span> <span class="nx">key</span><span class="p">);</span>



<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如下是一个简单的内存ResourceLoader</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span class="kr">public</span> <span class="kr">class</span> <span class="nx">MapResourceLoader</span> <span class="kr">implements</span> <span class="nx">ResourceLoader</span>
<span class="p">{</span>
        <span class="nx">Map</span> <span class="nx">data</span><span class="p">;</span>

        <span class="kr">public</span> <span class="nx">MapResourceLoader</span><span class="p">(</span><span class="nx">Map</span> <span class="nx">data</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="nx">Resource</span> <span class="nx">getResource</span><span class="p">(</span><span class="nb">String</span> <span class="nx">key</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="nb">String</span> <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="nx">data</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">StringTemplateResource</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="kr">boolean</span> <span class="nx">isModified</span><span class="p">(</span><span class="nx">Resource</span> <span class="nx">key</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="kr">boolean</span> <span class="nx">exist</span><span class="p">(</span><span class="nb">String</span> <span class="nx">key</span><span class="p">)</span>
        <span class="p">{</span>

                <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="k">void</span> <span class="nx">close</span><span class="p">()</span>
        <span class="p">{</span>

        <span class="p">}</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="k">void</span> <span class="nx">init</span><span class="p">(</span><span class="nx">GroupTemplate</span> <span class="nx">gt</span><span class="p">)</span>
        <span class="p">{</span>

        <span class="p">}</span>

        <span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="nb">String</span> <span class="nx">getResourceId</span><span class="p">(</span><span class="nx">Resource</span> <span class="nx">resource</span><span class="p">,</span> <span class="nb">String</span> <span class="nx">id</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="c1">//不需要计算相对路径</span>
                <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>init方法可以初始化GroupTemplate，比如读取配置文件的root属性，autoCheck属性，字符集属性，以及加载functions目录下的所有模板方法
如FileResourceLoader 的 init方法</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="err">@</span><span class="nx">Override</span>
        <span class="kr">public</span> <span class="k">void</span> <span class="nx">init</span><span class="p">(</span><span class="nx">GroupTemplate</span> <span class="nx">gt</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="nx">Map</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="nb">String</span><span class="o">&gt;</span> <span class="nx">resourceMap</span> <span class="o">=</span> <span class="nx">gt</span><span class="p">.</span><span class="nx">getConf</span><span class="p">().</span><span class="nx">getResourceMap</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">root</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">root</span> <span class="o">=</span> <span class="nx">resourceMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">);</span>

                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">charset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">charset</span> <span class="o">=</span> <span class="nx">resourceMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;charset&quot;</span><span class="p">);</span>

                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">functionSuffix</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">functionSuffix</span> <span class="o">=</span> <span class="nx">resourceMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;functionSuffix&quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">autoCheck</span> <span class="o">=</span> <span class="nb">Boolean</span><span class="p">.</span><span class="nx">parseBoolean</span><span class="p">(</span><span class="nx">resourceMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;autoCheck&quot;</span><span class="p">));</span>

                <span class="nx">File</span> <span class="nx">root</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">File</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">functionRoot</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">gt</span> <span class="o">=</span> <span class="nx">gt</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">exists</span><span class="p">())</span>
                <span class="p">{</span>
                        <span class="nx">readFuntionFile</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">functionRoot</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">));</span>
                <span class="p">}</span>

        <span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>readFuntionFile 方法将读取functions下的所有模板，并注册为方法</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="kr">protected</span> <span class="k">void</span> <span class="nx">readFuntionFile</span><span class="p">(</span><span class="nx">File</span> <span class="nx">funtionRoot</span><span class="p">,</span> <span class="nb">String</span> <span class="nx">ns</span><span class="p">,</span> <span class="nb">String</span> <span class="nx">path</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="nb">String</span> <span class="nx">expected</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">functionSuffix</span><span class="p">);</span>
                <span class="nx">File</span><span class="p">[]</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">funtionRoot</span><span class="p">.</span><span class="nx">listFiles</span><span class="p">();</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">File</span> <span class="nx">f</span> <span class="o">:</span> <span class="nx">files</span><span class="p">)</span>
                <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span>
                        <span class="p">{</span>
                                <span class="c1">//读取子目录</span>
                                <span class="nx">readFuntionFile</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">getName</span><span class="p">().</span><span class="nx">concat</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span> <span class="nx">path</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">getName</span><span class="p">()).</span><span class="nx">concat</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">));</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">getName</span><span class="p">().</span><span class="nx">endsWith</span><span class="p">(</span><span class="nx">functionSuffix</span><span class="p">))</span>
                        <span class="p">{</span>
                                <span class="nb">String</span> <span class="nx">resourceId</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="nx">f</span><span class="p">.</span><span class="nx">getName</span><span class="p">();</span>
                                <span class="nb">String</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">getName</span><span class="p">();</span>
                                <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">fileName</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nx">fileName</span><span class="p">.</span><span class="nx">length</span><span class="p">()</span> <span class="o">-</span> <span class="nx">functionSuffix</span><span class="p">.</span><span class="nx">length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
                                <span class="nb">String</span> <span class="nx">functionName</span> <span class="o">=</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">fileName</span><span class="p">);</span>
                                <span class="nx">FileFunctionWrapper</span> <span class="nx">fun</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileFunctionWrapper</span><span class="p">(</span><span class="nx">resourceId</span><span class="p">);</span>
                                <span class="nx">gt</span><span class="p">.</span><span class="nx">registerFunction</span><span class="p">(</span><span class="nx">functionName</span><span class="p">,</span> <span class="nx">fun</span><span class="p">);</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>Resource类需要实现OpenReader方法，以及isModified方法。对于模板内容存储在数据库中，openReader返回一个Clob，isModified 则需要根据改模板内容对应的lastUpdate（通常数据库应该这么设计）来判断模板是否更改</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="kr">public</span> <span class="kr">abstract</span> <span class="kr">class</span> <span class="nx">Resource</span>
<span class="p">{</span>


        <span class="cm">/**</span>
<span class="cm">         * 打开一个新的Reader</span>
<span class="cm">         *</span>
<span class="cm">         * @return</span>
<span class="cm">         */</span>
        <span class="kr">public</span> <span class="kr">abstract</span> <span class="nx">Reader</span> <span class="nx">openReader</span><span class="p">();</span>

        <span class="cm">/**</span>
<span class="cm">         * 检测资源是否改变</span>
<span class="cm">         *</span>
<span class="cm">         * @return</span>
<span class="cm">         */</span>
        <span class="kr">public</span> <span class="kr">abstract</span> <span class="kr">boolean</span> <span class="nx">isModified</span><span class="p">();</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>参考例子可以参考beetl自带的ResourceLoader</p></div>
</div>
<div class="sect2">
<h3 id="_使用compositeresourceloader">3.8. 使用CompositeResourceLoader</h3>
<div class="paragraph"><p>组合加载器，可以包含多个已有的ResourceLoader，如下代码创建一个包含俩个文件和内存的ResourceLoader</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">FileResourceLoader</span> <span class="n">fileLoader1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileResourceLoader</span><span class="o">(</span><span class="n">path1</span><span class="o">);</span>
<span class="n">FileResourceLoader</span> <span class="n">fileLoader2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileResourceLoader</span><span class="o">(</span><span class="n">path2</span><span class="o">);</span>
<span class="n">Map</span> <span class="n">data</span> <span class="o">=</span> <span class="n">getData</span><span class="o">();</span>
<span class="c1">// 根据id加载</span>
<span class="n">MapResourceLoader</span> <span class="n">mapLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MapResourceLoader</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>


<span class="n">CompositeResourceLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CompositeResourceLoader</span><span class="o">();</span>
<span class="n">loader</span><span class="o">.</span><span class="na">addResourceLoader</span><span class="o">(</span><span class="k">new</span> <span class="n">StartsWithMatcher</span><span class="o">(</span><span class="s">&quot;http:&quot;</span><span class="o">).</span><span class="na">withoutPrefix</span><span class="o">(),</span> <span class="n">fileLoader2</span><span class="o">);</span>
<span class="n">loader</span><span class="o">.</span><span class="na">addResourceLoader</span><span class="o">(</span><span class="k">new</span> <span class="n">StartsWithMatcher</span><span class="o">(</span><span class="s">&quot;db:&quot;</span><span class="o">),</span> <span class="n">mapLoader</span><span class="o">);</span>
<span class="n">loader</span><span class="o">.</span><span class="na">addResourceLoader</span><span class="o">(</span><span class="k">new</span> <span class="n">AllowAllMatcher</span><span class="o">(),</span> <span class="n">fileLoader1</span><span class="o">);</span>

<span class="n">GroupTemplate</span> <span class="n">gt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroupTemplate</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span>
<span class="n">Template</span> <span class="n">t</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="s">&quot;/xxx.html&quot;</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如上例子，groupTemplate从CompositeResourceLoader里加载/xxx.html，由于http:和db:前缀都不匹配，因此，将实际采用fileLoader1加载path1+/xxx.html，如下是xxx.html文件内容</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="n">include</span><span class="o">(</span><span class="s">&quot;/xxx2.html&quot;</span><span class="o">){}</span>
<span class="n">include</span><span class="o">(</span><span class="s">&quot;http:/xxx.html&quot;</span><span class="o">){}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>第2行仍然是由fileLoader1加载，但第3行以http:前缀开头，因此将fileLoader2加载path2+/xxx.html.xxx.html内容如下</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="n">include</span><span class="o">(</span><span class="s">&quot;db:1&quot;</span><span class="o">){}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>因为以db:开头，因此会采用MapResourceLoader加载，内容是key为db:1对模板</p></div>
</div>
<div class="sect2">
<h3 id="_自定义错误处理器">3.9. 自定义错误处理器</h3>
<div class="paragraph"><p>错误处理器需要实现ErrorHandler接口的processExcption(BeetlException beeExceptionos, Writer writer);</p></div>
<div class="ulist"><ul>
<li>
<p>
beeExceptionos，模板各种异常
</p>
</li>
<li>
<p>
writer 模板使用的输出流。系统自带的并未采用此Writer，而是直接输出到控制台
</p>
</li>
</ul></div>
<div class="paragraph"><p>自定义错误处理可能是有多个原因，比如</p></div>
<div class="paragraph"><p>1 想将错误输出到页面而不是控制台</p></div>
<div class="paragraph"><p>2 错误输出美化一下，而不是自带的格式</p></div>
<div class="paragraph"><p>3 错误输出的内容做调整，如不输出错误行的模板内容，而仅仅是错误提示</p></div>
<div class="paragraph"><p>4 错误输出到日志系统里</p></div>
<div class="paragraph"><p>5 不仅仅输出日志，还抛出异常。默认自带的不会抛出异常，ReThrowConsoleErrorHandler 继承了ConsoleErrorHandler方法，打印异常后抛出</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReThrowConsoleErrorHandler</span> <span class="kd">extends</span> <span class="n">ConsoleErrorHandler</span>
<span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processExcption</span><span class="o">(</span><span class="n">BeetlException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">Writer</span> <span class="n">writer</span><span class="o">)</span>
        <span class="o">{</span>

                <span class="kd">super</span><span class="o">.</span><span class="na">processExcption</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">writer</span><span class="o">);</span>
                <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>

        <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>beetl 提供 ErrorInfo类来wrap BeetlException，转化为较为详细的提示信息，他具有如下信息</p></div>
<div class="ulist"><ul>
<li>
<p>
type 一个简单的中文描述
</p>
</li>
<li>
<p>
errorCode 内部使用的错误类型标识
</p>
</li>
<li>
<p>
errorTokenText 错误发生的节点文本
</p>
</li>
<li>
<p>
errorTokenLine 错误行
</p>
</li>
<li>
<p>
msg 错误消息，有可能没有，因为有时候errorCode描述的已经很清楚了
</p>
</li>
<li>
<p>
cause 错误的root 异常，也可能没有。
</p>
</li>
</ul></div>
<div class="paragraph"><p>BeetlException 也包含了一个关键信息就是 resourceId，即出错所在的模板文件</p></div>
</div>
<div class="sect2">
<h3 id="_自定义安全管理器">3.10. 自定义安全管理器</h3>
<div class="paragraph"><p>所有模板的本地调用都需要通过安全管理器校验，默认需要实现NativeSecurityManager 的public boolean permit(String resourceId, Class c, Object target, String method) 方法</p></div>
<div class="paragraph"><p>如下是默认管理器的实现方法</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultNativeSecurityManager</span> <span class="kd">implements</span> <span class="n">NativeSecurityManager</span>
<span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">permit</span><span class="o">(</span><span class="n">String</span> <span class="n">resourceId</span><span class="o">,</span> <span class="n">Class</span> <span class="n">c</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">method</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">isArray</span><span class="o">())</span>
                <span class="o">{</span>
                        <span class="c1">//允许调用，但实际上会在在其后调用中报错。不归此处管理</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getPackage</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pkg</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;java.lang&quot;</span><span class="o">))</span>
                <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Runtime&quot;</span><span class="o">)</span> <span class="o">||</span> <span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Process&quot;</span><span class="o">)</span> <span class="o">||</span> <span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;ProcessBuilder&quot;</span><span class="o">)</span>
                                        <span class="o">||</span> <span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;System&quot;</span><span class="o">))</span>
                        <span class="o">{</span>
                                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="o">}</span>
                <span class="o">}</span>

                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_注册全局共享变量">3.11. 注册全局共享变量</h3>
<div class="paragraph"><p>groupTemplate.setSharedVars(Map&lt;String, Object&gt; sharedVars)</p></div>
</div>
<div class="sect2">
<h3 id="_布局">3.12. 布局</h3>
<div class="paragraph"><p>布局可以通过Beetl提供的include,layout 以及模板变量来完成。模板变量能完成复杂的布局</p></div>
<div class="ulist"><ul>
<li>
<p>
采用layout include
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre> <span class="o">&lt;%</span>
 <span class="c1">//content.html内容如下：</span>
 <span class="n">layout</span><span class="o">(</span><span class="s">&quot;/inc/layout.html&quot;</span><span class="o">){%&gt;</span>
 <span class="k">this</span> <span class="n">is</span> <span class="n">正文</span>
 <span class="o">..........</span>
 <span class="o">&lt;%}%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如上一个子页面将使用layout布局页面，layout 页面内容如下</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre> <span class="o">&lt;%</span><span class="n">include</span><span class="o">(</span><span class="s">&quot;/inc/header.html&quot;</span><span class="o">){}</span> <span class="o">%&gt;</span>
 <span class="k">this</span> <span class="n">is</span> <span class="n">content</span><span class="o">:</span><span class="n">$</span><span class="o">{</span><span class="n">layoutContent</span><span class="o">}</span>
 <span class="k">this</span> <span class="n">is</span> <span class="n">footer</span><span class="o">:</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>layoutContent 是默认变量，也可以改成其他名字，具体请参考layout标签函数</p></div>
<div class="paragraph"><p>全局变量总是能被布局用的页面所使用，如果布局页面需要临时变量，则需要显示的传入，如：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre> <span class="o">&lt;%</span>
 <span class="n">var</span> <span class="n">user</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="na">user</span><span class="o">;</span>
 <span class="n">include</span><span class="o">(</span><span class="s">&quot;/inc/header.html&quot;</span><span class="o">,{</span><span class="n">title</span><span class="o">:</span><span class="err">&#39;</span><span class="n">这是一个测试页面</span><span class="err">&#39;</span><span class="o">,</span><span class="n">user</span><span class="o">:</span><span class="n">user</span><span class="o">}){}</span> <span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>这样，title和user成为全局变量，能被header.html 及其子页面引用到</p></div>
<div class="ulist"><ul>
<li>
<p>
继承布局：采用模板变量和include
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre> <span class="o">&lt;%</span>
        <span class="n">var</span> <span class="n">jsPart</span> <span class="o">=</span> <span class="o">{</span>
 <span class="o">%&gt;</span>
   <span class="n">web页面js部分</span>

 <span class="o">&lt;%};%&gt;</span>

 <span class="o">&lt;%</span>
        <span class="n">var</span> <span class="n">htmlPart</span> <span class="o">=</span> <span class="o">{</span>
 <span class="o">%&gt;</span>
   <span class="n">web页面html部分</span>

 <span class="o">&lt;%};</span>
  <span class="n">include</span><span class="o">(</span><span class="s">&quot;/inc/layout.html&quot;</span><span class="o">,{</span><span class="n">jsSecition</span><span class="o">:</span><span class="n">jsPart</span><span class="o">,</span><span class="n">htmlSection</span><span class="o">:</span><span class="n">htmlPart</span><span class="o">}){}</span>
 <span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>layout.html页面如下：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;head&gt;</span>
${jsSection}
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
.......
${htmlSection}
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_性能优化">3.13. 性能优化</h3>
<div class="paragraph"><p>Beetl性能已经很快了，有些策略能更好提高性能</p></div>
<div class="ulist"><ul>
<li>
<p>
使用二进制输出，此策略可以使模板在语法分析的时候将静态文本转化为二进制，省去了运行时刻编码时间，这是主要性能提高方式。但需要注意，此时需要提供一个二进制输出流，而不是字符流，否则性能反而下降
</p>
</li>
<li>
<p>
使用FastRuntimeEngine，默认配置。 此引擎能对语法树做很多优化，从而提高运行性能，如生成字节码来访问属性而不是传统的反射访问。关于引擎，可能在新的版本推出更好的引擎，请随时关注。
</p>
</li>
<li>
<p>
通过@type 来申明全局变量类型，这不能提高运行性能，但有助于模板维护
</p>
</li>
<li>
<p>
自定义ResourceLoader的isModified必须尽快返回，因此每次渲染模板的时候都会调用此方法
</p>
</li>
</ul></div>
<div class="paragraph"><p>为什么Beetl性能这么好&#8230;&#8230;&#8230;&#8230;(待续)</p></div>
</div>
<div class="sect2">
<h3 id="_分布式缓存模板">3.14. 分布式缓存模板</h3>
<div class="paragraph"><p>Beetl模板引擎模板在同一个虚拟机里缓存Beetl 脚本。也可以将缓存脚本到其他地方，只要实现Cache接口，并设置ProgramCacheFactory.cache即可，这样GroupTemplate将从你提供的Cache中存取Beetl脚本</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>此功能未被很好测试</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_定制输出">3.15. 定制输出</h3>
<div class="paragraph"><p>占位符输出允许定制。如所有日期类型都按照某个格式化输出，而不需要显示的使用格式化输出，或者为了防止跨脚本站点攻击，需要对类型为String的值做检查等，不必使用格式化函数，可以直接对占位符输出进行定制，代码如下</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">PlaceholderST</span><span class="o">.</span><span class="na">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PlaceholderST</span><span class="o">.</span><span class="na">Output</span><span class="o">(){</span>

                                        <span class="nd">@Override</span>
                                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">Context</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
                                                <span class="c1">//定制输出</span>
                                                <span class="n">ctx</span><span class="o">.</span><span class="na">byteWriter</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="s">&quot;ok&quot;</span><span class="o">+</span><span class="n">value</span><span class="o">!=</span><span class="kc">null</span><span class="o">?</span><span class="n">value</span><span class="o">.</span><span class="na">toString</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="o">);</span>

                                        <span class="o">}</span>

                                <span class="o">};</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如果PlaceholderST静态变量output 不为null，将使用output 来输出</p></div>
</div>
<div class="sect2">
<h3 id="_定制模板引擎">3.16. 定制模板引擎</h3>
<div class="paragraph"><p>Beetl在线体验（http://ibeetl.com:8080/beetlonline/）面临一个挑战，允许用户输入任何脚本做练习或者分享代码。但又需要防止用户输入恶意的代码，如</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="k">for</span><span class="o">(</span><span class="n">var</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10000000</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
        <span class="c1">//其他代码</span>
<span class="o">}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>此时，需要定制模板引擎，遇到for循环的时候，应该限制循环次数，譬如，在线体验限制最多循5次，这是通过定义替换GeneralForStatement类来完成的，这个类对应了for(exp;exp;exp) ，我们需要改成如下样子：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">RestrictForStatement</span> <span class="kd">extends</span> <span class="n">GeneralForStatement</span>
<span class="o">{</span>
        <span class="kd">public</span> <span class="nf">RestrictForStatement</span><span class="o">(</span><span class="n">GeneralForStatement</span> <span class="n">gf</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="kd">super</span><span class="o">(</span><span class="n">gf</span><span class="o">.</span><span class="na">varAssignSeq</span><span class="o">,</span> <span class="n">gf</span><span class="o">.</span><span class="na">expInit</span><span class="o">,</span> <span class="n">gf</span><span class="o">.</span><span class="na">condtion</span><span class="o">,</span> <span class="n">gf</span><span class="o">.</span><span class="na">expUpdate</span><span class="o">,</span> <span class="n">gf</span><span class="o">.</span><span class="na">forPart</span><span class="o">,</span> <span class="n">gf</span><span class="o">.</span><span class="na">elseforPart</span><span class="o">,</span> <span class="n">gf</span><span class="o">.</span><span class="na">token</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Context</span> <span class="n">ctx</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">expInit</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="o">{</span>
                        <span class="k">for</span> <span class="o">(</span><span class="n">Expression</span> <span class="n">exp</span> <span class="o">:</span> <span class="n">expInit</span><span class="o">)</span>
                        <span class="o">{</span>
                                <span class="n">exp</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                        <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">varAssignSeq</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="o">{</span>
                        <span class="n">varAssignSeq</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                <span class="o">}</span>


                <span class="kt">boolean</span> <span class="n">hasLooped</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="o">{</span>
                        <span class="kt">boolean</span> <span class="n">bool</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span> <span class="n">condtion</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">bool</span><span class="o">)</span>
                        <span class="o">{</span>
                                <span class="n">hasLooped</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="n">forPart</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                                <span class="k">switch</span> <span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">gotoFlag</span><span class="o">)</span>
                                <span class="o">{</span>
                                        <span class="k">case</span> <span class="n">IGoto</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">:</span>
                                                <span class="k">break</span><span class="o">;</span>
                                        <span class="k">case</span> <span class="n">IGoto</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">:</span>
                                                <span class="n">ctx</span><span class="o">.</span><span class="na">gotoFlag</span> <span class="o">=</span> <span class="n">IGoto</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">;</span>
                                                <span class="k">continue</span><span class="o">;</span>
                                        <span class="k">case</span> <span class="n">IGoto</span><span class="o">.</span><span class="na">RETURN</span><span class="o">:</span>
                                                <span class="k">return</span><span class="o">;</span>
                                        <span class="k">case</span> <span class="n">IGoto</span><span class="o">.</span><span class="na">BREAK</span><span class="o">:</span>
                                                <span class="n">ctx</span><span class="o">.</span><span class="na">gotoFlag</span> <span class="o">=</span> <span class="n">IGoto</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">;</span>
                                                <span class="k">return</span><span class="o">;</span>
                                <span class="o">}</span>

                        <span class="o">}</span>
                        <span class="k">else</span>
                        <span class="o">{</span>
                                <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>

                        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">expUpdate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="o">{</span>
                                <span class="k">for</span> <span class="o">(</span><span class="n">Expression</span> <span class="n">exp</span> <span class="o">:</span> <span class="n">expUpdate</span><span class="o">)</span>
                                <span class="o">{</span>
                                        <span class="n">exp</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                                <span class="o">}</span>
                        <span class="o">}</span>

                <span class="o">}</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="o">)</span>
                <span class="o">{</span>
                        <span class="k">try</span>
                        <span class="o">{</span>
                                <span class="n">ctx</span><span class="o">.</span><span class="na">byteWriter</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="s">&quot;--Too may Data in loop，Ignore the left Data  for Online Engine--&quot;</span><span class="o">);</span>
                                <span class="n">ctx</span><span class="o">.</span><span class="na">byteWriter</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>


                        <span class="o">}</span>
                        <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span>
                        <span class="o">{</span>
                                <span class="c1">// TODO Auto-generated catch block</span>
                                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                        <span class="o">}</span>
                <span class="o">}</span>

        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">infer</span><span class="o">(</span><span class="n">InferContext</span> <span class="n">inferCtx</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">infer</span><span class="o">(</span><span class="n">inferCtx</span><span class="o">);</span>

        <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>尽管上面代码很复杂，但实际上是改写了原来的GeneralForStatement，将原来的24行while(true) 替换成for (; i &lt; 5; i++) 用来控制最大循环，并且62行检测如果循环退出后，i等于5，则提示Too Many Data in Loop.</p></div>
<div class="paragraph"><p>现在需要将此类替换原有的GeneralForStatement，</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OnlineTemplateEngine</span> <span class="kd">extends</span> <span class="n">DefaultTemplateEngine</span>
<span class="o">{</span>
        <span class="kd">public</span> <span class="n">Program</span> <span class="nf">createProgram</span><span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="n">Reader</span> <span class="n">reader</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">textMap</span><span class="o">,</span> <span class="n">String</span> <span class="n">cr</span><span class="o">,</span>
                        <span class="n">GroupTemplate</span> <span class="n">gt</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="n">Program</span> <span class="n">program</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">createProgram</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="n">reader</span><span class="o">,</span> <span class="n">textMap</span><span class="o">,</span> <span class="n">cr</span><span class="o">,</span> <span class="n">gt</span><span class="o">);</span>
                <span class="n">modifyStatemetn</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span><span class="n">program</span><span class="o">,</span><span class="n">gt</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">program</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">modifyStatemetn</span><span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span><span class="o">,</span><span class="n">Program</span> <span class="n">program</span><span class="o">,</span><span class="n">GroupTemplate</span> <span class="n">gt</span><span class="o">){</span>
                <span class="n">Statement</span><span class="o">[]</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="na">metaData</span><span class="o">.</span><span class="na">statements</span><span class="o">;</span>
                <span class="n">StatementParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StatementParser</span><span class="o">(</span><span class="n">sts</span><span class="o">,</span> <span class="n">gt</span><span class="o">,</span> <span class="n">resource</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
                <span class="n">parser</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">WhileStatement</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">RestrictLoopNodeListener</span><span class="o">());</span>
                <span class="n">parser</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">GeneralForStatement</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">RestrictLoopNodeListener</span><span class="o">());</span>
                <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">();</span>
        <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>继承FastRuntimeEngine有所不同，因为改引擎会copy出一个脚本做分析优化，因此，俩个脚本都需要做修改</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OnlineTemplateEngine</span> <span class="kd">extends</span> <span class="n">FastRuntimeEngine</span>
<span class="o">{</span>
        <span class="kd">public</span> <span class="n">Program</span> <span class="nf">createProgram</span><span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="n">Reader</span> <span class="n">reader</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">textMap</span><span class="o">,</span> <span class="n">String</span> <span class="n">cr</span><span class="o">,</span>
                        <span class="n">GroupTemplate</span> <span class="n">gt</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="n">FilterProgram</span> <span class="n">program</span> <span class="o">=</span> <span class="o">(</span><span class="n">FilterProgram</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">createProgram</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="n">reader</span><span class="o">,</span> <span class="n">textMap</span><span class="o">,</span> <span class="n">cr</span><span class="o">,</span> <span class="n">gt</span><span class="o">);</span>
                <span class="n">modifyStatemetn</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span><span class="n">program</span><span class="o">,</span><span class="n">gt</span><span class="o">);</span>
                <span class="n">modifyStatemetn</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span><span class="n">program</span><span class="o">.</span><span class="na">getCopy</span><span class="o">(),</span><span class="n">gt</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">program</span><span class="o">;</span>
        <span class="o">}</span>


<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="ulist"><ul>
<li>
<p>
StatementParser 是关键类，他允许对模板的Program进行解析，并替换其中的Statement。parser.addListener 方法接受俩个参数，第一个是需要找的类，第二个是执行的监听器。
</p>
</li>
<li>
<p>
可以参考在线体验的源码：http://git.oschina.net/xiandafu/beetlonline/blob/master/src/org/bee/tl/online/OnlineTemplateEngine.java
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">RestrictLoopNodeListener</span> <span class="kd">implements</span> <span class="n">Listener</span>
<span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">onEvent</span><span class="o">(</span><span class="n">Event</span> <span class="n">e</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="n">Stack</span> <span class="n">stack</span> <span class="o">=</span> <span class="o">(</span><span class="n">Stack</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">getEventTaget</span><span class="o">();</span>
                <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="na">peek</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">GeneralForStatement</span><span class="o">)</span>
                <span class="o">{</span>
                        <span class="n">GeneralForStatement</span> <span class="n">gf</span> <span class="o">=</span> <span class="o">(</span><span class="n">GeneralForStatement</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
                        <span class="n">RestrictForStatement</span> <span class="n">rf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RestrictForStatement</span><span class="o">(</span><span class="n">gf</span><span class="o">);</span>
                        <span class="k">return</span> <span class="n">rf</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="k">else</span>
                <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
        <span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>该监听器返回一个新的RestrictForStatement 类，用来替换来的GeneralForStatement。如果返回null，则不需替换。这通常发生在你仅仅通过修改该类的某些属性就可以的场景</p></div>
<div class="paragraph"><p>完成这些代码后，在配置文件中申明使用新的引擎</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">ENGINE</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="na">bee</span><span class="o">.</span><span class="na">tl</span><span class="o">.</span><span class="na">online</span><span class="o">.</span><span class="na">OnlineTemplateEngine</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>这样就完成了模板引擎定制。</p></div>
</div>
<div class="sect2">
<h3 id="_直接运行beetl脚本">3.17. 直接运行Beetl脚本</h3>
<div class="paragraph"><p>Beetl模板本质上会转化为Beetl脚本来执行，这点跟jsp转为servlet来执行类似。GroupTemplate提供方法可以直接执行Beetl脚本</p></div>
<div class="ulist"><ul>
<li>
<p>
public Map runScript(String key, Map&lt;String, Object&gt; paras) throws ScriptEvalError
</p>
</li>
<li>
<p>
public Map runScript(String key, Map&lt;String, Object&gt; paras, Writer w) throws ScriptEvalError
</p>
</li>
<li>
<p>
public Map runScript(String key, Map&lt;String, Object&gt; paras, Writer w, ResourceLoader loader) throws ScriptEvalError
</p>
</li>
</ul></div>
<div class="paragraph"><p>key为资源名，paras为脚本的全局变量，w可选参数，如果执行脚本有输出，则输出到w里,loader参数可选，如果指定，则使用此laoder加载脚本</p></div>
<div class="paragraph"><p>执行脚本完毕后，返回到Map里的值可能包含如下：</p></div>
<div class="ulist"><ul>
<li>
<p>
模板的<strong>顶级</strong>的临时变量,key为临时变量名
</p>
</li>
<li>
<p>
return 值将返回到map里 ，key为return
</p>
</li>
</ul></div>
<div class="paragraph"><p>如下脚本（此时就不需要脚本定界符了）</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">var</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
<span class="n">var</span> <span class="n">b</span> <span class="o">=</span> <span class="n">date</span><span class="o">();</span>
<span class="n">var</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;2&#39;</span><span class="o">;</span>
<span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>调用runScript后，map里将返回key分别为a,b,c，return。 值分别为1，当前日期，字符串'2，以及3.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_web集成">4. Web集成</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_web提供的全局变量">4.1. Web提供的全局变量</h3>
<div class="paragraph"><p>Web集成模块向模板提供web标准的变量，做如下说明</p></div>
<div class="ulist"><ul>
<li>
<p>
request 中的所有attribute.在模板中可以直接通过attribute name 来引用，如在controller层 request.setAttribute("user",user),则在模板中可以直接用${user.name} .
</p>
</li>
<li>
<p>
session  提供了session会话，模板通过session["name"],或者session.name 引用session里的变量
</p>
</li>
<li>
<p>
request  标准的HTTPSerlvetRequest,可以在模板里引用request属性（getter），如${request.requestURL}。
</p>
</li>
<li>
<p>
parameter 用户读取用户提交的参数。如${parameter.userId} (仅仅2.2.7以上版本支持)
</p>
</li>
<li>
<p>
ctxPath  Web应用ContextPath
</p>
</li>
<li>
<p>
servlet  是WebVariable的实例，包含了HTTPSession,HTTPSerlvetRequest,HTTPSerlvetResponse.三个属性，模板中可以通过request.response,session 来引用，如 ${serlvet.request.requestURL};
</p>
</li>
<li>
<p>
所有的GroupTemplate的共享变量
</p>
</li>
<li>
<p>
pageCtx是一个内置方法 ，仅仅在web开发中，用于设置一个变量，然后可以在页面渲染过程中，调用此api获取，如pageCtx("title","用户添加页面")，在其后任何地方，可以pageCtx("title") 获取该变量。(仅仅2.2.7以上版本支持)
</p>
</li>
</ul></div>
<div class="paragraph"><p>你可以在模板任何地方访问这些变量</p></div>
<div class="paragraph"><p>如果你需要扩展更多属性，你也可以配置beetl.properties配置文件的WEBAPP_EXT属性，实现WebRenderExt接口，在渲染模板之前增加自己的扩展，如:</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>RESOURCE.root=/WEB-INF/views
WEBAPP_EXT = com.park.oss.util.GlobalExt
</pre></div>
</td></tr></table></div></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlobalExt</span> <span class="kd">implements</span> <span class="n">WebRenderExt</span><span class="o">{</span>

        <span class="kd">static</span> <span class="kt">long</span> <span class="n">version</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">modify</span><span class="o">(</span><span class="n">Template</span> <span class="n">template</span><span class="o">,</span> <span class="n">GroupTemplate</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">HttpServletRequest</span> <span class="n">arg2</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">arg3</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//js,css 的版本编号</span>
                <span class="n">template</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="s">&quot;sysVersion&quot;</span><span class="o">,</span><span class="n">version</span><span class="o">);</span>
        <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>这样，每次在模板里都可以访问变量sysVersion了，不需要再controller里设置，或者通过servlet filter来设置</p></div>
</div>
<div class="sect2">
<h3 id="_集成技术开发指南">4.2. 集成技术开发指南</h3>
<div class="paragraph"><p>Beetl默认提供了WebRender用于帮助web集成开发，所有内置的集成均基于此方法。如果你认为Beetl内置的各个web框架集成功能不够，你可以继承此类，或者参考此类源码重新写，其代码如下</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.beetl.ext.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Writer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Enumeration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.beetl.core.GroupTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.beetl.core.Template</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.beetl.core.exception.BeetlException</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> *  通常web渲染的类，将request变量赋值给模板，同时赋值的还有session,request,ctxPath</span>
<span class="cm"> *  其他框架可以继承此类做更多的定制</span>
<span class="cm"> * @author joelli</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebRender</span>
<span class="o">{</span>
        <span class="n">GroupTemplate</span> <span class="n">gt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">WebRender</span><span class="o">(</span><span class="n">GroupTemplate</span> <span class="n">gt</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">gt</span> <span class="o">=</span> <span class="n">gt</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**</span>
<span class="cm">         * @param key 模板资源id</span>
<span class="cm">         * @param request</span>
<span class="cm">         * @param response</span>
<span class="cm">         * @param args 其他参数，将会传给modifyTemplate方法</span>
<span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">render</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="n">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span>

                <span class="o">{</span>
                        <span class="c1">//                      response.setContentType(contentType);</span>
                        <span class="n">Template</span> <span class="n">template</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                        <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">attrs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttributeNames</span><span class="o">();</span>

                        <span class="k">while</span> <span class="o">(</span><span class="n">attrs</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span>
                        <span class="o">{</span>
                                <span class="n">String</span> <span class="n">attrName</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
                                <span class="n">template</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="n">attrName</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">attrName</span><span class="o">));</span>

                        <span class="o">}</span>
                        <span class="n">WebVariable</span> <span class="n">webVariable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebVariable</span><span class="o">();</span>
                        <span class="n">webVariable</span><span class="o">.</span><span class="na">setRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
                        <span class="n">webVariable</span><span class="o">.</span><span class="na">setResponse</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
                        <span class="n">webVariable</span><span class="o">.</span><span class="na">setSession</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">());</span>

                        <span class="n">template</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="s">&quot;session&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SessionWrapper</span><span class="o">(</span><span class="n">webVariable</span><span class="o">.</span><span class="na">getSession</span><span class="o">()));</span>

                        <span class="n">template</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="s">&quot;servlet&quot;</span><span class="o">,</span> <span class="n">webVariable</span><span class="o">);</span>
                        <span class="n">template</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="s">&quot;request&quot;</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
                        <span class="n">template</span><span class="o">.</span><span class="na">binding</span><span class="o">(</span><span class="s">&quot;ctxPath&quot;</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">());</span>

                        <span class="n">modifyTemplate</span><span class="o">(</span><span class="n">template</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

                        <span class="n">String</span> <span class="n">strWebAppExt</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="na">getConf</span><span class="o">().</span><span class="na">getWebAppExt</span><span class="o">();</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">strWebAppExt</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
                                <span class="n">WebRenderExt</span> <span class="n">renderExt</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getWebRenderExt</span><span class="o">(</span><span class="n">strWebAppExt</span><span class="o">);</span>
                                <span class="n">renderExt</span><span class="o">.</span><span class="na">modify</span><span class="o">(</span><span class="n">template</span><span class="o">,</span> <span class="n">gt</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">gt</span><span class="o">.</span><span class="na">getConf</span><span class="o">().</span><span class="na">isDirectByteOutput</span><span class="o">())</span>
                        <span class="o">{</span>
                                <span class="n">os</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
                                <span class="n">template</span><span class="o">.</span><span class="na">renderTo</span><span class="o">(</span><span class="n">os</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="k">else</span>
                        <span class="o">{</span>
                                <span class="n">writer</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
                                <span class="n">template</span><span class="o">.</span><span class="na">renderTo</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
                        <span class="o">}</span>

                <span class="o">}</span>
                <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span>
                <span class="o">{</span>
                        <span class="n">handleClientError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">catch</span> <span class="o">(</span><span class="n">BeetlException</span> <span class="n">e</span><span class="o">)</span>
                <span class="o">{</span>
                        <span class="n">handleBeetlException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="k">finally</span>
                <span class="o">{</span>
                        <span class="k">try</span>
                        <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                        <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">os</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="o">{</span>
                                        <span class="n">os</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                                <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span>
                        <span class="o">{</span>
                                <span class="n">handleClientError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                        <span class="o">}</span>
                <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**</span>
<span class="cm">         * 可以添加更多的绑定</span>
<span class="cm">         * @param template 模板</span>
<span class="cm">         * @param key 模板的资源id</span>
<span class="cm">         * @param request</span>
<span class="cm">         * @param response</span>
<span class="cm">         * @param args  调用render的时候传的参数</span>
<span class="cm">         */</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">modifyTemplate</span><span class="o">(</span><span class="n">Template</span> <span class="n">template</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
                        <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span>
        <span class="o">{</span>

        <span class="o">}</span>

        <span class="cm">/**处理客户端抛出的IO异常</span>
<span class="cm">         * @param ex</span>
<span class="cm">         */</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">handleClientError</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="c1">//do nothing</span>
        <span class="o">}</span>

        <span class="cm">/**处理客户端抛出的IO异常</span>
<span class="cm">         * @param ex</span>
<span class="cm">         */</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">handleBeetlException</span><span class="o">(</span><span class="n">BeetlException</span> <span class="n">ex</span><span class="o">)</span>
        <span class="o">{</span>
                <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_serlvet集成">4.3. Serlvet集成</h3>
<div class="paragraph"><p>只需要在Servlet代码里引用ServletGroupTemplate就能集成Beetl，他提供了一个render(String child, HttpServletRequest request, HttpServletResponse response)方法。例子如下：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
                        <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>

                <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="o">);</span>
                <span class="c1">//模板直接访问users</span>
                <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">,</span><span class="n">service</span><span class="o">.</span><span class="na">getUsers</span><span class="o">());</span>
                <span class="n">ServletGroupTemplate</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">render</span><span class="o">(</span><span class="s">&quot;/index.html&quot;</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>


        <span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>ServletGroupTemplate同其他web集成一样，将读取配置文件来配置，如果需要通过代码配置，可以在Serlvet listener里 ServletGroupTemplate.instance().getGroupTemplate()方法获取GroupTemplate</p></div>
</div>
<div class="sect2">
<h3 id="_springmvc集成">4.4. SpringMVC集成</h3>
<div class="paragraph"><p>需要做如下配置即可</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;beetlConfig&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.BeetlGroupUtilConfiguration&quot;</span> <span class="na">init-method=</span><span class="s">&quot;init&quot;</span><span class="nt">/&gt;</span>


<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;viewResolver&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.BeetlSpringViewResolver&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;contentType&quot;</span> <span class="na">value=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>同其他集成方式一样，模板的配置将放在beetl.properties中。</p></div>
<div class="paragraph"><p>如果想获取GroupTemplate,可以调用如下代码</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">BeetlGroupUtilConfiguration</span> <span class="n">config</span> <span class="o">=</span> <span class="o">(</span><span class="n">BeetlGroupUtilConfiguration</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">getBean</span><span class="o">(</span>
                                <span class="s">&quot;beetlConfig&quot;</span><span class="o">);</span>
<span class="n">GroupTemplate</span> <span class="n">group</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getGroupTemplate</span><span class="o">();</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>Controller代码如下:</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">ModelAndView</span> <span class="nf">index</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ModelAndView</span> <span class="n">view</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ModelAndView</span><span class="o">(</span><span class="s">&quot;/index&quot;</span><span class="o">);</span>
        <span class="c1">//total 是模板的全局变量，可以直接访问</span>
        <span class="n">view</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="s">&quot;total&quot;</span><span class="o">,</span><span class="n">service</span><span class="o">.</span><span class="na">getCount</span><span class="o">());</span>
  <span class="k">return</span> <span class="n">view</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p><a href="http://git.oschina.net/xiandafu/springbeetlsql">http://git.oschina.net/xiandafu/springbeetlsql</a>  有完整例子</p></div>
</div>
<div class="sect2">
<h3 id="_springmvc集成高级">4.5. SpringMVC集成高级</h3>
<div class="paragraph"><p>spring集成还允许注册被spring容器管理的Function，Tag等，也还允许配置多个视图解析器等功能</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;beetlConfig&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.BeetlGroupUtilConfiguration&quot;</span> <span class="na">init-method=</span><span class="s">&quot;init&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configFileResource&quot;</span> <span class="na">value=</span><span class="s">&quot;/WEB-INF/beetl.properties&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;functions&quot;</span><span class="nt">&gt;</span>
             <span class="nt">&lt;map&gt;</span>
               <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;testFunction&quot;</span> <span class="na">value-ref=</span><span class="s">&quot;testFunction&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>

        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;functionPackages&quot;</span><span class="nt">&gt;</span>
             <span class="nt">&lt;map&gt;</span>
               <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;fp&quot;</span> <span class="na">value-ref=</span><span class="s">&quot;testFunctionPackage&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>

        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;tagFactorys&quot;</span><span class="nt">&gt;</span>
             <span class="nt">&lt;map&gt;</span>
               <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;html.output&quot;</span> <span class="na">value-ref=</span><span class="s">&quot;testTagFactory&quot;</span><span class="nt">/&gt;</span>
               <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;html.output2&quot;</span> <span class="na">value-ref=</span><span class="s">&quot;testTagFactory2&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>

<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;testTagFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.SpringBeanTagFactory&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;testTag&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;testTagFactory2&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.SpringBeanTagFactory&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;testTag2&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>


<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;beetlViewResolver&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.BeetlSpringViewResolver&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;config&quot;</span> <span class="na">ref=</span><span class="s">&quot;beetlConfig&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;contentType&quot;</span> <span class="na">value=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如上图所示，BeetlGroupUtilConfiguration有很多属性，列举如下</p></div>
<div class="ulist"><ul>
<li>
<p>
configFileResource 属性指定了配置文件所在路径，如果不指定，则默认在classpath下
</p>
</li>
<li>
<p>
functions 指定了被spring容器管理的function，key为注册的方法名，value-ref 指定的bean的名称
</p>
</li>
<li>
<p>
functionPackages，指定了被spring容器管理的functionPackage，key为注册的方法包名，value-ref 指定的bean的名称
</p>
</li>
<li>
<p>
tagFactorys ，注册tag类，key是tag类的名称，value-ref指向一个org.beetl.ext.spring.SpringBeanTagFactory实例，该子类是一个Spring管理的Bean。属性name对应的bean就是tag类。需要注意，由于Tag是有状态的，因此，必须申明Scope为 "prototype"。如代码:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@Service</span>
<span class="nd">@Scope</span><span class="o">(</span><span class="s">&quot;prototype&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestTag</span> <span class="kd">extends</span> <span class="n">Tag</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="ulist"><ul>
<li>
<p>
typeFormats: 同functions，参数是 Map&lt;Class&lt;?&gt;, Format&gt;，其中key为类型Class
</p>
</li>
<li>
<p>
formats：同functions，参数是 Map&lt;String, Format&gt;，其中key为格式化函数名
</p>
</li>
<li>
<p>
virtualClassAttributes 同functions，参数Map&lt;Class&lt;?&gt;, VirtualClassAttribute&gt;，其中key为类型Class
</p>
</li>
<li>
<p>
virtualAttributeEvals ，类型为List&lt;VirtualAttributeEval&gt;
</p>
</li>
<li>
<p>
resourceLoader，资源加载器 ，值是 实现ResourceLoader的一个Bean
</p>
</li>
<li>
<p>
errorHandler ，错误处理，值是实现ErrorHandler的一个Bean
</p>
</li>
<li>
<p>
sharedVars,同functions，类型是Map&lt;String, Object&gt;，可以在此设置共享变量
</p>
</li>
<li>
<p>
configProperties，类型是Properties，可以覆盖配置文件的某些属性
</p>
</li>
</ul></div>
<div class="paragraph"><p>如下配置，指定了三个视图解析器，一个用于beetl页面渲染，一个用于cms，采用了beetl技术，另外一个一些遗留的页面采用jsp</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;beetlConfig&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.BeetlGroupUtilConfiguration&quot;</span> <span class="na">init-method=</span><span class="s">&quot;init&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configFileResource&quot;</span> <span class="na">value=</span><span class="s">&quot;/WEB-INF/beetl.properties&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>


<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;cmsbeetlConfig&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.BeetlGroupUtilConfiguration&quot;</span> <span class="na">init-method=</span><span class="s">&quot;init&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configFileResource&quot;</span> <span class="na">value=</span><span class="s">&quot;/WEB-INF/cms-beetl.properties&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>


<span class="c">&lt;!-- Beetl视图解析器1 --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;beetlViewResolver&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.BeetlSpringViewResolver&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 多视图解析器，需要设置viewNames和order --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;viewNames&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;list&gt;</span>
                        <span class="nt">&lt;value&gt;</span>/template/**<span class="nt">&lt;/value&gt;</span>
                <span class="nt">&lt;/list&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;suffix&quot;</span> <span class="na">value=</span><span class="s">&quot;.btl&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;contentType&quot;</span> <span class="na">value=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;order&quot;</span> <span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 多GroupTemplate，需要指定使用的bean --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;config&quot;</span> <span class="na">ref=</span><span class="s">&quot;beetlConfig&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- Beetl视图解析器2 --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;cmsBeetlViewResolver&quot;</span> <span class="na">class=</span><span class="s">&quot;org.beetl.ext.spring.BeetlSpringViewResolver&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 多视图解析器，需要设置viewNames和order --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;viewNames&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;list&gt;</span>
                        <span class="nt">&lt;value&gt;</span>/cmstemplate/**<span class="nt">&lt;/value&gt;</span>
                <span class="nt">&lt;/list&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;contentType&quot;</span> <span class="na">value=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;order&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 多GroupTemplate，需要指定使用的bean --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;config&quot;</span> <span class="na">ref=</span><span class="s">&quot;cmsbeetlConfig&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- JSP视图解析器 --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">&quot;JSPViewResolver&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 注意JSP的这个视图解析器order必须在最后 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;order&quot;</span> <span class="na">value=</span><span class="s">&quot;256&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- beetl配置不支持前缀，这不同于jsp 和 freemaker --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;prefix&quot;</span> <span class="na">value=</span><span class="s">&quot;/WEB-INF/&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;suffix&quot;</span> <span class="na">value=</span><span class="s">&quot;.jsp&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;contentType&quot;</span> <span class="na">value=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>Beetl视图解析器属性同spring自带的视图解析器一样，支持contentType,order,prefix,suffix等属性。</p></div>
<div class="paragraph"><p>注意视图解析器里属性viewNames，这个用于判断controller返回的path到底应该交给哪个视图解析器来做。</p></div>
<div class="ulist"><ul>
<li>
<p>
以/template开头的是beetlViewResolver来渲染。
</p>
</li>
<li>
<p>
以/cmstemplate是交给cmsBeetlViewResolver渲染。
</p>
</li>
<li>
<p>
如果都没有匹配上，则是jsp渲染
</p>
</li>
</ul></div>
<div class="paragraph"><p>如果你想更改此规则，你只能增加canHandle方法指定你的逻辑了。详情参考org.springframework.web.servlet.view.UrlBasedViewResolver.canHandle</p></div>
<div class="paragraph"><p>对于仅仅需要redirect和forward的那些请求，需要加上相应的前缀</p></div>
<div class="ulist"><ul>
<li>
<p>
以"redirect:"为前缀时：表示重定向，不产生BeetlView渲染模版，而直接通过Servlet的机制返回重定向响应.redirect:前缀后面的内容为重定向地址，可以采用相对地址（相对当前url)，绝对地址(完整的url)，如果采用/开头的地址，会自动的在前面接上当前Web应用的contextPath，即contextPath为test的Web应用中使用redirect:/admin/login.html 实际重定向地址为 /test/admin/login.html
</p>
</li>
<li>
<p>
以"forward:"为前缀时：表示转发，不产生BeetlView渲染模版。而是直接通过Servlet的机制转发请求（关于转发和重定向的区别，请自行查看Servlet API) forward:前缀后面的内容为转发地址，一般都是以/开头相对于当前Web应用的根目录
</p>
</li>
</ul></div>
<div class="paragraph"><p>其他集成需要注意的事项:</p></div>
<div class="ulist"><ul>
<li>
<p>
spring集成，请不要使用spring的 前缀配置,改用beetl的RESOURCE.ROOT 配置，否则include，layout会找不到模板
</p>
</li>
<li>
<p>
spring boot，因为是从classpath里加载模板文件，所以请使用ClasspathResourceLoader来初始化GroupTemplate，而不要使用FileResourceLoader
</p>
</li>
<li>
<p>
spring boot集成需要注意的是要添加spring-devtools.properties文件,并配置如下选项
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>restart.include.beetl=/beetl-xxx.jar
restart.include.beetlsql=/beetlsql-xxx..jar
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>spring-devtools.properties 为spring boot的配置文件,位于META-INF目录下</p></div>
</div>
<div class="sect2">
<h3 id="_jodd集成">4.6. Jodd集成</h3>
<div class="paragraph"><p>需要配置web.xml,将所有请求交给jodd处理，参考:http://jodd.org/doc/madvoc/setup.html</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>madvoc<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>jodd.madvoc.MadvocServletFilter<span class="nt">&lt;/filter-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
                        <span class="nt">&lt;param-name&gt;</span>madvoc.webapp<span class="nt">&lt;/param-name&gt;</span>
                        <span class="nt">&lt;param-value&gt;</span>test.MyWebApplication<span class="nt">&lt;/param-value&gt;</span>
          <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;init-param&gt;</span>
                <span class="nt">&lt;param-name&gt;</span>madvoc.configurator<span class="nt">&lt;/param-name&gt;</span>
                <span class="nt">&lt;param-value&gt;</span>test.MyAutomagicMadvocConfigurator<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>

<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>madvoc<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>MyWebApplication 和 MyAutomagicMadvocConfigurator 需要自己参照如下例子写一个，前者用来设置beetl作为视图渲染，后者配置Jodd不要扫描beetl struts集成里引用的struts类</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyAutomagicMadvocConfigurator</span> <span class="kd">extends</span> <span class="n">AutomagicMadvocConfigurator</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nf">MyAutomagicMadvocConfigurator</span><span class="o">(){</span>
                <span class="kd">super</span><span class="o">();</span>
                <span class="c1">//不扫描beetl 里jar文件里的action和result，否则，会扫描StrutsResultSupport不相干的class</span>
                <span class="k">this</span><span class="o">.</span><span class="na">rulesJars</span><span class="o">.</span><span class="na">exclude</span><span class="o">(</span><span class="s">&quot;**/*beetl*.jar&quot;</span><span class="o">);</span>


        <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyWebApplication</span>  <span class="kd">extends</span> <span class="n">WebApplication</span><span class="o">{</span>
     <span class="nd">@Override</span>
     <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">MadvocConfig</span> <span class="n">madvocConfig</span><span class="o">,</span> <span class="n">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="o">{</span>
                 <span class="c1">//设置默认</span>
         <span class="n">madvocConfig</span><span class="o">.</span><span class="na">setDefaultActionResult</span><span class="o">(</span><span class="n">BeetlActionResult</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>最后，可以写Action了，浏览器输入/index.html,jodd将执行world方法，并渲染ok.html模板。如果你想配置GroupTemplate，正如其他集成框架一样，只需要写一个beetl.properties 即可。</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@MadvocAction</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexAction</span> <span class="o">{</span>

     <span class="nd">@Out</span>
     <span class="n">String</span> <span class="n">value</span><span class="o">;</span>
     <span class="nd">@Action</span><span class="o">(</span><span class="s">&quot;/index.html&quot;</span><span class="o">)</span>
     <span class="kd">public</span> <span class="n">String</span> <span class="nf">world</span><span class="o">()</span> <span class="o">{</span>

         <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;Hello World!&quot;</span><span class="o">;</span>
         <span class="k">return</span> <span class="s">&quot;/ok.html&quot;</span><span class="o">;</span>
     <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p><a href="https://git.oschina.net/xiandafu/beetl-jodd-sample">https://git.oschina.net/xiandafu/beetl-jodd-sample</a> 有完整例子</p></div>
</div>
<div class="sect2">
<h3 id="_jfinal集成">4.7. JFinal集成</h3>
<div class="paragraph"><p>Beetl提供 JFinal 集成，使用BeetlRenderFactory ，通过如下注册即可使用beetl模板引擎</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">org.beetl.ext.jfinal.BeetlRenderFactory</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoConfig</span> <span class="kd">extends</span> <span class="n">JFinalConfig</span>
<span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configConstant</span><span class="o">(</span><span class="n">Constants</span> <span class="n">me</span><span class="o">)</span>
        <span class="o">{</span>

                <span class="n">me</span><span class="o">.</span><span class="na">setMainRenderFactory</span><span class="o">(</span><span class="k">new</span> <span class="n">BeetlRenderFactory</span><span class="o">());</span>
                <span class="c1">// 获取GroupTemplate ,可以设置共享变量等操作</span>
                <span class="n">GroupTemplate</span> <span class="n">groupTemplate</span> <span class="o">=</span> <span class="n">BeetlRenderFactory</span><span class="o">.</span><span class="na">groupTemplate</span> <span class="o">;</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>业务逻辑代码:</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">modify</span><span class="o">(){</span>
                <span class="kt">int</span> <span class="n">artId</span> <span class="o">=</span> <span class="n">getParaToInt</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
                <span class="n">setAttr</span><span class="o">(</span><span class="s">&quot;title&quot;</span><span class="o">,</span> <span class="s">&quot;修改文章&quot;</span><span class="o">);</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">Cate</span><span class="o">&gt;</span> <span class="n">cateLists</span> <span class="o">=</span> <span class="n">Cate</span><span class="o">.</span><span class="na">getAllCate</span><span class="o">();</span>
                <span class="c1">//模板里访问cateLists,atr,</span>
                <span class="n">setAttr</span><span class="o">(</span><span class="s">&quot;cateLists&quot;</span><span class="o">,</span> <span class="n">cateLists</span><span class="o">);</span>
                <span class="n">setAttr</span><span class="o">(</span><span class="s">&quot;art&quot;</span><span class="o">,</span> <span class="n">Article</span><span class="o">.</span><span class="na">dao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">artId</span><span class="o">));</span>
                <span class="n">render</span><span class="o">(</span><span class="s">&quot;/modify.html&quot;</span><span class="o">);</span>
        <span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>BeetlRenderFactory 默认使用FileResourceLoader ，其根目录位于WebRoot目录下，如果你需要修改到别的目录，可以设置配置文件，如</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">RESOURCE</span><span class="o">.</span><span class="na">root</span><span class="o">=</span> <span class="o">/</span><span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">template</span><span class="o">/</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p><a href="https://git.oschina.net/xiandafu/beetl-jfinal-sample">https://git.oschina.net/xiandafu/beetl-jfinal-sample</a>  有完整例子，采用jfinal+beetl写的一个博客系统</p></div>
</div>
<div class="sect2">
<h3 id="_nutz集成">4.8. Nutz集成</h3>
<div class="paragraph"><p>Nutz集成提供了 BeetlViewMaker ，实现了 ViewMaker方法，如下代码</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre>        <span class="nd">@At</span><span class="o">(</span><span class="s">&quot;/ctx&quot;</span><span class="o">)</span>
        <span class="nd">@Ok</span><span class="o">(</span><span class="s">&quot;beetl:ctx.btl&quot;</span><span class="o">)</span>
        <span class="kd">public</span> <span class="n">Context</span> <span class="nf">withContext</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">Context</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">Lang</span><span class="o">.</span><span class="na">context</span><span class="o">();</span>
                <span class="n">Pager</span> <span class="n">pager</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="na">createPager</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">20</span><span class="o">);</span>
                <span class="n">pager</span><span class="o">.</span><span class="na">setRecordCount</span><span class="o">(</span><span class="n">dao</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">UserProfile</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">pager</span><span class="o">);</span>
                <span class="n">ctx</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;pager&quot;</span><span class="o">,</span> <span class="n">pager</span><span class="o">);</span>
                <span class="n">ctx</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;list&quot;</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
        <span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Beetl<span class="err">&amp;</span>Nutz<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;p&gt;</span>总共 ${list.~size}<span class="nt">&lt;p/&gt;</span>
<span class="err">&lt;</span>%
for(user in list){
%&gt;
<span class="nt">&lt;p&gt;</span>hello,${user.nickname};<span class="nt">&lt;p/&gt;</span>
<span class="err">&lt;</span>%}%&gt;

<span class="nt">&lt;p&gt;</span>当前页${pager.pageNumber},总共${pager.pageCount}页<span class="nt">&lt;p/&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_struts2集成">4.9. Struts2集成</h3>
<div class="paragraph"><p>需要在struts2配置文件里添加result-types做如下配置</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;default&quot;</span> <span class="na">namespace=</span><span class="s">&quot;/&quot;</span> <span class="na">extends=</span><span class="s">&quot;struts-default&quot;</span><span class="nt">&gt;</span>
.......
<span class="nt">&lt;result-types&gt;</span>
        <span class="nt">&lt;result-type</span> <span class="na">name=</span><span class="s">&quot;beetl&quot;</span>
                                <span class="na">class=</span><span class="s">&quot;org.beetl.ext.struts2.Struts2BeetlActionResult&quot;</span> <span class="na">default=</span><span class="s">&quot;true&quot;</span> <span class="nt">&gt;</span>
                                <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;contentType&quot;</span><span class="nt">&gt;</span>text/html; charset=UTF-8<span class="nt">&lt;/param&gt;</span>
        <span class="nt">&lt;/result-type&gt;</span>
<span class="nt">&lt;/result-types&gt;</span>

<span class="nt">&lt;action</span> <span class="na">name=</span><span class="s">&quot;HelloWorld&quot;</span> <span class="na">class=</span><span class="s">&quot;com.beetl.struts.HelloWorld&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result&gt;</span>/hello.html<span class="nt">&lt;/result&gt;</span>
<span class="nt">&lt;/action&gt;</span>
<span class="nt">&lt;action</span> <span class="na">name=</span><span class="s">&quot;Ajax&quot;</span> <span class="na">class=</span><span class="s">&quot;com.beetl.struts.AjaxHtml&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;result&gt;</span>/table.html#table<span class="nt">&lt;/result&gt;</span>
<span class="nt">&lt;/action&gt;</span>
........
<span class="nt">&lt;/package&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>该类会根据struts配置文件获取模板，如上例的hello.html,并将formbean的属性，以及request属性作为全局变量传递给模板</p></div>
<div class="paragraph"><p><a href="https://git.oschina.net/xiandafu/beetl-struts2-sample">https://git.oschina.net/xiandafu/beetl-struts2-sample</a>  有完整例子</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">郑重申明</div>
<div class="paragraph"><p>鉴于struts2有安全漏洞，而官方补丁打法很消极，所以请谨慎使用Struts2，Beetl的安全性已经通过在线体验和多个使用Beetl的网站得以体现
一旦你的struts2网站被攻破，请先确定是否是struts2 的问题</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_直接web中运行beetl模板">4.10. 直接Web中运行Beetl模板</h3>
<div class="paragraph"><p>对于web应用来说，必须通过controller才能渲染模板，beetl也可以写完模板后，在未完成controller情况下，直接渲染模板
此方法既可以作为通常的全栈式开发人员使用，也可以用于前端人员单独开发模板用。</p></div>
<div class="paragraph"><p>步骤如下：</p></div>
<div class="ulist"><ul>
<li>
<p>
配置监听器，监听器指定对*.btl的请求进行监听(假定模板名字都是以btl.结尾)。
</p>
</li>
<li>
<p>
实现监听器，该监听器继承父类 org.beetl.ext.web.SimpleCrossFilter，实现protected abstract GroupTemplate getGroupTemplate()方法。依据不同的集成方式，比如你的环境是Servlet，则只需要调用ServletGroupTemplate.instance().getGroupTemplate(),如果是Jfinal，需要调用BeetlRenderFactory.groupTemplate等
</p>
</li>
<li>
<p>
SimpleCrossFilter 提供一些有用的方法，可以帮助你定制一些特性，可以参考源码了解
</p>
</li>
<li>
<p>
置完成后，对于要测试的模板，可以新建一个对应的伪模型文件，比如要测试模板WebRoot/user/userList.html,可以新建立WebRoot/values/user/userList.html.var 。 values是监听器默认的伪模型的根目录
</p>
</li>
<li>
<p>
编辑伪模型文件，对应于userList.html需要的全局变量，userList.html.var可以申明这些些变量
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">var</span> <span class="n">proudct</span> <span class="o">=</span> <span class="o">{</span><span class="n">id</span><span class="o">:</span><span class="mi">1</span><span class="o">,</span><span class="n">name</span><span class="o">:</span><span class="err">&#39;</span><span class="n">测试产品</span><span class="err">&#39;</span><span class="o">,</span><span class="n">pic</span><span class="o">:</span><span class="err">&#39;</span><span class="n">xxxx</span><span class="o">.</span><span class="na">jpg</span><span class="err">&#39;</span><span class="o">};</span>
<span class="n">var</span> <span class="n">userList</span> <span class="o">=</span> <span class="o">[{</span><span class="n">id</span><span class="o">:</span><span class="mi">2</span><span class="o">,</span><span class="n">name</span><span class="o">:</span><span class="err">&#39;</span><span class="n">用户一</span><span class="err">&#39;</span><span class="o">}];</span>
<span class="n">var</span> <span class="n">session</span><span class="o">=</span> <span class="o">{</span><span class="n">admin</span><span class="o">:{</span><span class="n">id</span><span class="o">:</span><span class="mi">1</span><span class="o">,</span><span class="n">name</span><span class="o">:</span><span class="err">&#39;</span><span class="n">admin</span><span class="err">&#39;</span><span class="o">}};</span>
</pre></div>
</td></tr></table></div></div>
<div class="ulist"><ul>
<li>
<p>
通过浏览器直接访问http://ip:port/user/userList.html,监听器会预先执行userList.html.var，并将返回值作为模板的全局变量，传给userList.html
</p>
</li>
<li>
<p>
可以将一些公共的变量放到WebRoot/values/common.var里（比如上面代码的session）. 监听器会先执行common.var,然后再执行userList.html.var
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>直接访问模板前提是使用了伪模型，这与实际的项目采用的模型并不一致，因此当模板采用伪模型验证后，需要重启web应用，才能使用真正的模型去测试，否则，模板引擎会报错，这是因为beetl默认的FastRuntimeEngine会根据模型优化模板，对同一个模板不同的模型会报错，除非采用DefaultTemplateEngine 或者页面申明类型变量是动态的。</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_整合ajax的局部渲染技术">4.11. 整合ajax的局部渲染技术</h3>
<div class="paragraph"><p>越来越多web网站依赖于ajax，如table的翻页，流行方式是浏览器发出ajax请求，后台处理后返回一个json，浏览器端将json数据拆开，拼成一条一条的行数据，然后生成dom节点，追加到表格里。
作为另外一种可选技术，beetl支持局部渲染技术，允许后台处理返回的是一个完成的html片段，这样，前端浏览器可以直接将这个html片段追加到表格里。在我做的性能测试里，俩种方式性能差别不大(<a href="http://beetlajax.oschina.mopaas.com/">http://beetlajax.oschina.mopaas.com/</a>)</p></div>
<div class="paragraph"><p>比如模板index.html有很多动态内容，有动态生成的菜单，有右侧的top10，也有核心区域的表格，大概内容如下</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="err">&lt;</span>#menu/&gt;
<span class="err">&lt;</span>#top10&gt; ....<span class="err">&lt;</span>/#top10&gt;
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;table-container&quot;</span> <span class="nt">&gt;</span>
<span class="err">&lt;</span>%
//ajax片段开始
#ajax userTable: {
%&gt;

<span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;&lt;td</span> <span class="na">width=</span><span class="s">100</span><span class="nt">&gt;</span>id<span class="nt">&lt;/td&gt;&lt;td</span> <span class="na">width=</span><span class="s">100</span><span class="nt">&gt;</span>姓名<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
        <span class="err">&lt;</span>%for(user in users){%&gt;
        <span class="nt">&lt;tr&gt;&lt;td&gt;</span>${user.id}<span class="nt">&lt;/td&gt;&lt;td&gt;</span>${user.name}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
        <span class="err">&lt;</span>%}%&gt;
<span class="nt">&lt;/table&gt;</span>

当前页面<span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;current&quot;</span><span class="nt">&gt;</span>${page!1}<span class="nt">&lt;/span&gt;&lt;span</span> <span class="na">style=</span><span class="s">&quot;width:20px&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;&lt;span</span>  <span class="na">class=</span><span class="s">&quot;page&quot;</span><span class="nt">&gt;</span>next<span class="nt">&lt;/span&gt;&lt;/a&gt;</span> <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="nt">&gt;&lt;span</span>  <span class="na">class=</span><span class="s">&quot;page&quot;</span><span class="nt">&gt;</span>pre<span class="nt">&lt;/span&gt;&lt;/a&gt;</span>
<span class="err">&lt;</span>%
//ajax片段结尾
}
%&gt;
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>#ajax 用于告诉告诉模板引擎，此处是个局部渲染标记，标记为"userTable",对于正常渲染视图"index.html"页面,#ajax标记没什么用处,table仍能得到正常渲染。如果渲染的视图是index.html#userTable,则模板只会渲染#ajax标记得模板片段，其他部分将忽略。关于完整例子，可以参考http://beetlajax.oschina.mopaas.com/</p></div>
<div class="paragraph"><p>后台代码如下:</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">render</span><span class="o">(</span><span class="s">&quot;/index.html#userTable&quot;</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>ajax 片段渲染也支持默认情况下不渲染，仅仅做为一个片段使用，如一个页面有许多后台交互操作，并返回相应的html片段，可以将这些html片段也放到同一个模板里，使用ajax norender，表示渲染整个模板的时候默认并不需要渲染此ajax片段</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="err">&lt;</span>%
<span class="nt">&lt;html&gt;</span>

<span class="nt">&lt;/html&gt;</span>
#ajax norender success: {
%&gt;
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;success&quot;</span><span class="nt">&gt;</span> 操作成功
<span class="nt">&lt;/div&gt;</span>

<span class="err">&lt;</span>%
}
%&gt;

#ajax norender failure: {
%&gt;
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;failure&quot;</span><span class="nt">&gt;</span> 操作失败
<span class="nt">&lt;/div&gt;</span>

<span class="err">&lt;</span>%
}
%&gt;
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>这样，此页面默认情况下并没有输出success,和 failure片段</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>注意，Ajax片段本质上是从模版的ajax标记处开始渲染，因此，ajax需要的变量在模版里也必须是全局变量，如果你只是个局部变量，beetl会报出找不到变量，即使你binding了这个变量，beetl也认为这个是局部变量，如：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre>&quot; &gt;
<span class="err">&lt;</span>%
var tableData = paras.table;
#ajax userTable: {
for(user in tableData);
%&gt;

<span class="err">&lt;</span>%
//ajax片段结尾
}
%&gt;
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>变量tableData是从paras里获取的，是个临时变量，因此就算你在后台binding了一个tableData，beetl 也不能识别。在渲染ajax片段的时候会报变量tableData找不到。改正的办法只能是让tableData全局变量。</p></div>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>返回Json好还是返回html片段好？这个难以定论.</p></div>
<div class="ulist"><ul>
<li>
<p>
从后台性能看，将模型序列化成json性能会比渲染模板性能更好，但是，json还需要前端重新解析生成最终html dom节点，这可能会延迟最终数据的现实效果。而返回的html片段就是已经生成好的dom
</p>
</li>
<li>
<p>
从网络传入来看，json无疑更好的，html片段会有额外的html标记，css属性，以及有可能的js调用。传入流量有可能增加50%到100%。但是，对于web应用类，这些额外数据，并不算多。
</p>
</li>
<li>
<p>
从开发效率来讲，返回html片段的开发效率更高一些，因为渲染在后台操作，可以随心所欲的用模板语言来渲染，来取得后台数据，完成复杂渲染，而json就比较困难，可以说所有的json lib都没有完美的解决办法。
</p>
</li>
<li>
<p>
从用户体验上来讲，Beetl 采用ajax标记，混合了传统的模板渲染和ajax加载。用户进入页面即能看到数据，而经典的ajax json方式还需要异步加载，显示延迟。另外如果页面同时有多个ajax加载，则会对服务器造成很大的压力。
</p>
</li>
<li>
<p>
关心服务器cpu消耗？ 模板方式消耗更多的cpu，json方式则少点。但是俩者差距并不大。而且更多的web网站面临的情况是有富余的服务器CPU能力
</p>
</li>
<li>
<p>
关心客户端CPU消耗？ 过多的js无疑是客户端运行慢的主要原因。如果采用经典的json方式，返回的json数据必然还需要经过js的计算和渲染。会影响客户机器cpu。
</p>
</li>
</ul></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_在页面输出错误提示信息">4.12. 在页面输出错误提示信息</h3>
<div class="paragraph"><p>2.2.3版本以后，新增加org.beetl.ext.web.WebErrorHandler,可以在web开发的时候在页面输出提示信息，在产品模式下载后台输出提示信息（通过配置属性ESOURCE.autoCheck= true来认为是开发模式），仅仅需要配置如下:</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>ERROR_HANDLER = org.beetl.ext.web.WebErrorHandler
</pre></div>
</td></tr></table></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_附录">5. 附录</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_内置方法">5.1. 内置方法</h3>
<div class="sect3">
<h4 id="_常用内置方法">5.1.1. 常用内置方法</h4>
<div class="ulist"><ul>
<li>
<p>
date 返回一个java.util.Date类型的变量，如 date() 返回一个当前时间(对应java的java.util.Date); ${date( "2011-1-1" , "yyyy-MM-dd" )} 返回指定日期
</p>
</li>
<li>
<p>
print 打印一个对象  print(user.name);
</p>
</li>
<li>
<p>
println 打印一个对象以及回车换行符号，回车换号符号使用的是模板本身的，而不是本地系统的.如果仅仅打印一个换行符，则直接调用println() 即可
</p>
</li>
<li>
<p>
nvl 函数nvl，如果对象为null，则返回第二个参数，否则，返回自己  nvl(user,"不存在")
</p>
</li>
<li>
<p>
isEmpty 判断变量或者表达式是否为空，变量不存在，变量为null，变量是空字符串，变量是空集合，变量是空数组，此函数都将返回true
</p>
</li>
<li>
<p>
isNotEmpty  同上，判断对象是否不为空
</p>
</li>
<li>
<p>
has 变量名为参数，判断是否存在此全局变量，如 has(userList),类似于1.x版本的exist("userList"),但不需要输入引号了
</p>
</li>
<li>
<p>
assert 如果表达式为false，则抛出异常
</p>
</li>
<li>
<p>
trunc 截取数字，保留指定的小数位，如trunc(12.456,2) 输出是12.45
</p>
</li>
<li>
<p>
decode  一个简化的if else 结构，如 decode(a,1,"a=1",2,"a=2","不知道了")},如果a是1，这decode输出"a=1",如果a是2，则输出"a==2",
如果是其他值，则输出"不知道了"
</p>
</li>
<li>
<p>
debug 在控制台输出debug指定的对象以及所在模板文件以及模板中的行数，如debug(1),则输出1 [在3行@/org/beetl/core/lab/hello.txt],也可以输出多个，如debug("hi",a),则输出hi,a=123,[在3行@/org/beetl/core/lab/hello.txt]
</p>
</li>
<li>
<p>
parseInt 将数字或者字符解析为整形  如 parseInt("123");
</p>
</li>
<li>
<p>
parseLong 将数字或者字符解析为长整形，parseInt(123.12);
</p>
</li>
<li>
<p>
parseDouble 将数字或者字符解析为浮点类型 如parseDouble("1.23")
</p>
</li>
<li>
<p>
range 接收三个参数，初始值，结束值，还有步增（可以不需要，则默认为1），返回一个Iterator，常用于循环中，如for(var i in range(1,5)) {print(i)},将依次打印1234.
</p>
</li>
<li>
<p>
flush 强制io输出。
</p>
</li>
<li>
<p>
json，将对象转成json字符串，如 var data = json(userList)  可以跟一个序列化规则 如,var data = json(userList,"[*].id:i"),具体参考     <a href="https://git.oschina.net/xiandafu/beetl-json">https://git.oschina.net/xiandafu/beetl-json</a>
</p>
</li>
<li>
<p>
pageCtx ，仅仅在web开发中，设置一个变量，然后可以在页面渲染过程中，调用此api获取，如pageCtx("title","用户添加页面")，在其后任何地方，可以pageCtx("title") 获取该变量
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_字符串相关方法">5.1.2. 字符串相关方法</h4>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>strutil方法对参数均不做空指针检测，你可自定义方法来覆盖这些内置的方法</p></div>
</div></div>
<div class="ulist"><ul>
<li>
<p>
strutil.startWith     ${ strutil.startWith(“hello”,”he”) 输出是true
</p>
</li>
<li>
<p>
strutil.endWith       ${ strutil.endWith(“hello”,”o”) 输出是true
</p>
</li>
<li>
<p>
strutil.length        ${ strutil. length (“hello”),输出是5
</p>
</li>
<li>
<p>
strutil.subString     ${ strutil.subString (“hello”,1),输出是“ello”
</p>
</li>
<li>
<p>
strutil.subStringTo   ${ strutil.subStringTo (“hello”,1,2),输出是“e”
</p>
</li>
<li>
<p>
strutil.split ${ strutil.split (“hello,joeli”,”,”),输出是数组，有俩个元素，第一个是hello，第二个是joelli”
</p>
</li>
<li>
<p>
strutil.contain       ${ strutil.contain (“hello,”el”),输出是true
</p>
</li>
<li>
<p>
strutil.toUpperCase   ${ strutil.toUpperCase (“hello”),输出是HELLO
</p>
</li>
<li>
<p>
strutil.toLowerCase   ${ strutil.toLowerCase (“Hello”),输出是hello
</p>
</li>
<li>
<p>
strutil.replace       ${ strutil.replace (“Hello”,”lo”,”loooo”),输出是helloooo
</p>
</li>
<li>
<p>
strutil.format        ${ strutil.format (“hello,{0}, my age is {1}”,”joeli”,15),输出是hello,joelli, my age is 15.
具体请参考http://docs.oracle.com/javase/6/docs/api/java/text/MessageFormat.html
</p>
</li>
<li>
<p>
strutil.trim  去掉字符串的尾部空格
</p>
</li>
<li>
<p>
strutil.formatDate    var a = strutil.formatDate(user.bir,’yyyy-MM-dd’);
</p>
</li>
<li>
<p>
strutil.index  var index = strutil.index("abc","a");返回 索引0
</p>
</li>
<li>
<p>
strutil.lastIndex var index = strutil.lastIndex("aba","a");返回索引2
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_数组相关方法">5.1.3. 数组相关方法</h4>
<div class="ulist"><ul>
<li>
<p>
array.range  返回数组或者Collection一部分，接受三个参数，第一个是数组或者Collection子类，第二，三个参数分别是起始位置
</p>
</li>
<li>
<p>
array.remove 删除某个数组或者Collection的一个元素，并返回该数组或者Collection.第一个是数组或者Collection子类,第二个参数是元素
</p>
</li>
<li>
<p>
array.add 向数组或者Collection添加一个元素，并返回该数组或者Collection。第一个是数组或者Collection子类,第二个参数是元素
</p>
</li>
<li>
<p>
array.contain 判断数组或者元素是否包含元素，如果包含，返回true。否则false。第一个是数组或者Collection子类,第二个参数是元素
</p>
</li>
<li>
<p>
array.toArray 转化成数组,如array.toArray(1,2,"a");
</p>
</li>
<li>
<p>
array.collection2Array 将java集合转化为数组 array.collection2Array([1,2,''])
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_正则表达式相关方法">5.1.4. 正则表达式相关方法</h4>
<div class="ulist"><ul>
<li>
<p>
reg.match(str,regex)  str为需要处理的字符串，regex是表达式
</p>
</li>
<li>
<p>
reg.replace(str,regex,replace)，str为需要处理的字符串，regex是表达式，替换的字符串替换字符串
</p>
</li>
<li>
<p>
reg.find(str,regex) 返回找到的符合表达式的第一个字符串，否则返回空字符串
</p>
</li>
<li>
<p>
reg.findList(str,regex) 找到所有符合表达式的字符串，否则返回空列表
</p>
</li>
<li>
<p>
reg.split(str,regex),对字符串进行切分，返回列表
</p>
</li>
<li>
<p>
reg.split(str,regex,limit) 同上，limit是最多返回个数
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_内置格式化方法">5.2. 内置格式化方法</h3>
<div class="ulist"><ul>
<li>
<p>
dateFormat    日期格式化函数，如 $<em>yyyy-Mm-dd</em>，等于符号后的参数也可以没有，则使用本地默认来做格式化如
${date,dateFormat}
</p>
</li>
<li>
<p>
numberFormat  ${0.345,numberFormat="#.%"} 输出是 34.5%,具体请参考文档 <a href="http://docs.oracle.com/javase/6/docs/api/java/text/DecimalFormat.html">http://docs.oracle.com/javase/6/docs/api/java/text/DecimalFormat.html</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_内置标签函数">5.3. 内置标签函数</h3>
<div class="ulist"><ul>
<li>
<p>
include       include一个模板，如 :
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre> <span class="o">&lt;%</span><span class="nx">include</span><span class="p">(</span><span class="s2">&quot;/header.html&quot;</span><span class="p">){}</span><span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如果想往子模板中传入参数，则可以后面跟一个json变量</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>   <span class="o">&lt;%</span><span class="nx">include</span><span class="p">(</span><span class="s2">&quot;/header.html&quot;</span><span class="p">,{</span><span class="s1">&#39;user&#39;</span><span class="o">:</span><span class="nx">user</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}){}</span><span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>这样user，和id 可以在header.html被引用，并成为header.html的全局变量</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>(beetl1.2 也叫includeFileTemplate ，2.0仍然支持，但不再文档里体现了)</p></div>
</div></div>
<div class="ulist"><ul>
<li>
<p>
layout       提供一个布局功能，每个页面总是由一定布局，如页面头，菜单，页面脚，以及正文。 layout标签允许为正文指定一个布局，如下使用方式
</p>
<div class="literalblock">
<div class="content">
<pre><code>content.html内容如下：</code></pre>
</div></div>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre> <span class="o">&lt;%</span>
 <span class="c1">//content.html内容如下：</span>
 <span class="nx">layout</span><span class="p">(</span><span class="s2">&quot;/inc/layout.html&quot;</span><span class="p">){</span><span class="o">%&gt;</span>
 <span class="k">this</span> <span class="nx">is</span> <span class="nx">正文</span>
 <span class="p">..........</span>
 <span class="o">&lt;%%</span><span class="p">}</span><span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="literalblock">
<div class="content">
<pre><code>layout.html 是布局文件，内容如下•</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre> <span class="o">&lt;%</span>
 <span class="o">&lt;%</span><span class="nx">include</span><span class="p">(</span><span class="s2">&quot;/inc/header.html&quot;</span><span class="p">){}</span> <span class="o">%&gt;</span>
 <span class="k">this</span> <span class="nx">is</span> <span class="nx">content</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">layoutContent</span><span class="p">}</span>
 <span class="k">this</span> <span class="nx">is</span> <span class="nx">footer</span><span class="o">:</span>

 <span class="o">&lt;%%</span><span class="p">}</span><span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="literalblock">
<div class="content">
<pre><code>运行content.html模板文件后，，正文文件的内容将被替换到layoutContent的地方，变成如下内容</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>this is header
this is content:this is 正文
............
this is footer:</code></pre>
</div></div>
<div class="paragraph"><p>如果想往layout页面传入参数，则传入一个json变量，如下往layout.html页面传入一个用户登录时间</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre> <span class="o">&lt;%</span>
  <span class="nx">layout</span><span class="p">(</span><span class="s2">&quot;/inc/header.html&quot;</span><span class="p">,{</span><span class="s1">&#39;date&#39;</span><span class="o">:</span><span class="nx">user</span><span class="p">.</span><span class="nx">loginDate</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="o">:</span><span class="s2">&quot;内容页面&quot;</span><span class="p">}){</span><span class="o">%&gt;</span>
 <span class="k">this</span> <span class="nx">is</span> <span class="nx">正文</span>
 <span class="p">..........</span>

 <span class="o">&lt;%%</span><span class="p">}</span><span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>如果layoutContent 命名有冲突，可以在layout第三个参数指定，如</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre> <span class="o">&lt;%</span>

 <span class="nx">layout</span><span class="p">(</span><span class="s2">&quot;/inc/header.html&quot;</span><span class="p">,{</span><span class="s1">&#39;date&#39;</span><span class="o">:</span><span class="nx">user</span><span class="p">.</span><span class="nx">loginDate</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="o">:</span><span class="s2">&quot;内容页面&quot;</span><span class="p">},</span><span class="s2">&quot;myLayoutContent&quot;</span><span class="p">){</span><span class="o">%&gt;</span>
 <span class="k">this</span> <span class="nx">is</span> <span class="nx">正文</span>
 <span class="p">..........</span>

 <span class="o">&lt;%</span><span class="p">}</span><span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="ulist"><ul>
<li>
<p>
cache 能Cache标签的内容，并指定多长时间刷新，如
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%:</span><span class="nx">cache</span><span class="p">(</span><span class="s1">&#39;key2&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="kc">false</span><span class="p">){</span>  <span class="o">%&gt;</span>
<span class="nx">内容体</span>
<span class="o">&lt;%</span><span class="p">}</span><span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>需要指定三个参数，第一个是cache的Key值，第二个是缓存存在的时间，秒为单位，第三个表示是否强制刷新•，false表示不，true表示强制刷新
Cache默认实现org.beetl.ext.tag.cache.SimpleCacheManager. 你可以设置你自己的Cache实现，通过调用CacheTag. cacheManager= new YourCacheImplementation();</p></div>
<div class="paragraph"><p>可以在程序里调用如下方法手工删除Cache：</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearAll</span><span class="o">();</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearAll</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">);</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearAll</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">keys</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="ulist"><ul>
<li>
<p>
includeJSP,可以在模板里包括一个jsp文件，如：
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">&lt;%</span>
<span class="n">includeJSP</span><span class="o">(</span><span class="s">&quot;/xxxx.jsp&quot;</span><span class="o">,{</span><span class="s">&quot;key&quot;</span><span class="o">:</span><span class="s">&quot;value&quot;</span><span class="o">}){}</span>
<span class="o">%&gt;</span>
</pre></div>
</td></tr></table></div></div>
<div class="paragraph"><p>key value 都是字符串，将以parameter的形式提供给jsp，因此jsp可以通过request.getParameter("key")来获取参数</p></div>
<div class="paragraph"><p>主要注意的是，这个标签并非内置，需要手工注册一下</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">groupTemplate</span><span class="o">.</span><span class="na">registerTag</span><span class="o">(</span><span class="s">&quot;incdlueJSP&quot;</span><span class="o">,</span><span class="n">org</span><span class="o">.</span><span class="na">beetl</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">jsp</span><span class="o">.</span><span class="na">IncludeJSPTag</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="sect2">
<h3 id="_性能优化的秘密">5.4. 性能优化的秘密</h3>
<div class="paragraph"><p>Beetl2.0目前只完成了解释引擎，使用解释引擎好处是可以适用于各种场景，性能测试表明，Beetl2.0引擎是Freemaker的4－6倍，跟最好的
的编译引擎性能相比，也相差只有30%百分点。为什么Beetl能跑的如此之快呢，简单的说，有如下策略</p></div>
<div class="ulist"><ul>
<li>
<p>
优化IO输出，允许使用字节直接输出，模板中的静态文本事先转化为字节
</p>
</li>
<li>
<p>
encode优化，对于number类型，输出通常是.toString 转化成String，然后encode输出，这中间浪费了大量的资源，Beetl实现了encode，输出一步到位
</p>
</li>
<li>
<p>
Context 采用一维数组，语言里的Context通常采用Map实现，每次进入{} ，就新增一个child Map，尽管map很快，但不够快。也有其他模板语言采用二位数组提高性能，Beetl是通过固定大小一维数组来维护模板的Context，因此访问更快，也避免了Map和二维素组的频繁创建。其实除了此处，beetl很多地方都不采用Map来维护key-value, 而都采用数组索引，以追求性能极限
</p>
</li>
<li>
<p>
字节码访问属性，通过反射获取性能比较慢，就算JVM有优化，但优化效果也不确定。Beetl通过字节码生成了属性访问类，从而将属性访问速度提高了一个数量级
</p>
</li>
<li>
<p>
类型推测：Beetl 是强制类型的，因此预先知道类型，可以对模板做一些优化而省去了动态判断类型的时间
</p>
</li>
<li>
<p>
使用数组Buffer，避免频繁创建和销毁数组
</p>
</li>
<li>
<p>
编译引擎将模板编译成类，会产生大量的类，虚拟机很难对这些做优化。而解释引擎只有几十个固定的类，虚拟机容易优化
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="title">相关文章</div>
<div class="ulist"><ul>
<li>
<p>
为什么JSP会比Beetl慢 <a href="http://my.oschina.net/xiandafu/blog/475740">http://my.oschina.net/xiandafu/blog/475740</a>
</p>
</li>
<li>
<p>
Beetl 性能揭秘 2 ：语言如何存取变量 <a href="http://my.oschina.net/xiandafu/blog/293167">http://my.oschina.net/xiandafu/blog/293167</a>
</p>
</li>
<li>
<p>
Beetl 性能揭秘 1 ：如何输出一个整型变量 <a href="http://my.oschina.net/xiandafu/blog/284823">http://my.oschina.net/xiandafu/blog/284823</a>
</p>
</li>
</ul></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_性能测试对比">5.5. 性能测试对比</h3>
<div class="paragraph"><p>测试用例一 <a href="https://github.com/javamonkey/ebm">https://github.com/javamonkey/ebm</a></p></div>
<div class="paragraph"><p><span class="image">
<img src="performance.jpg" alt="performance.jpg" />
</span></p></div>
<div class="paragraph"><p>测试用例二 <a href="http://git.oschina.net/kiang/teb">http://git.oschina.net/kiang/teb</a></p></div>
<div class="paragraph"><p><span class="image">
<img src="performance2.png" alt="performance2.png" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_beetl_开发团队">5.6. Beetl 开发团队</h3>
<div class="paragraph"><p>作者</p></div>
<div class="ulist"><ul>
<li>
<p>
闲.大赋：
</p>
</li>
</ul></div>
<div class="paragraph"><p>助手</p></div>
<div class="ulist"><ul>
<li>
<p>
作死模式：核心代码开发
</p>
</li>
<li>
<p>
一粟蜉蝣：核心代码开发和版本发布
</p>
</li>
</ul></div>
<div class="paragraph"><p>代码捐助者</p></div>
<div class="ulist"><ul>
<li>
<p>
逝水fox ：出色完成spring集成
</p>
</li>
<li>
<p>
kraken: 集合方法等扩展
</p>
</li>
<li>
<p>
西安玛雅牛：复合加载器
</p>
</li>
<li>
<p>
级?!: beetl扩展，crossMVC
</p>
</li>
<li>
<p>
orangetys： beetl插件
</p>
</li>
<li>
<p>
Oo不懂oO: beetl插件
</p>
</li>
<li>
<p>
原上一颗草:Beetl早期使用者。
</p>
</li>
<li>
<p>
龙图腾飞 ，WebErrorHandler，用来开发模式在 web上显示错误而不是控制台
</p>
</li>
<li>
<p>
nutz: nutz 集成和MapResourceLoader
</p>
</li>
<li>
<p>
天方地圆 :提供正则方法
</p>
</li>
</ul></div>
<div class="paragraph"><p>文档校验</p></div>
<div class="ulist"><ul>
<li>
<p>
九月
</p>
</li>
<li>
<p>
Daemons
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2016-09-11 21:33:32 中国标准时间
</div>
</div>
</body>
</html>
